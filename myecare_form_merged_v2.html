<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyECare — Dose & Vial Calculator (Merged Mock v2)</title>
  <style>
    :root{
      --maroon-900:#5d0e17;
      --maroon-800:#6d121e;
      --maroon-700:#7d1624;
      --maroon-600:#8a1b2a;
      --maroon-500:#9a2231;
      --maroon-400:#b23340;
      --brand: var(--maroon-600);
      --ink:#1d1d1f;
      --muted:#6b7280;
      --bg:#ffffff;
      --card:#fafafa;
      --border:#e6e6e6;
      --radius:14px;
      --radius-sm:10px;
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --focus:0 0 0 3px rgba(154,34,49,.25);
      --danger:#b91c1c;
      --success:#167c3a;
      --warning:#b45309;
    }
    *{box-sizing:border-box}
    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
         margin:0;background:var(--bg);color:var(--ink);}
    h1,h2,h3{margin:0 0 .5rem 0}
    .container{max-width:980px;margin:36px auto;padding:0 16px}

    .info-banner{color:var(--brand);font-weight:700;margin-bottom:22px}

    .grid{display:grid;gap:18px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width: 820px){.grid.cols-2{grid-template-columns:1fr}}

    label{display:block;font-weight:600;margin:2px 0 8px 2px}
    .input, select, .date-input{
      width:100%; border:1px solid var(--border); padding:14px 14px;
      border-radius:var(--radius); background:#f7f7f8; color:var(--ink);
      outline:none; transition:border .15s, box-shadow .15s;
    }
    .input:focus, select:focus, .date-input:focus{border-color:var(--maroon-400); box-shadow:var(--focus); background:#fff}
    .readonly, .input[disabled], select[disabled]{color:#8e8e93;background:#f3f4f6;border-color:#ececec;cursor:not-allowed}
    .row{margin-bottom:18px}
    .section-lead{font-size:18px;font-weight:700;color:var(--brand);margin:8px 0 8px}

    fieldset{border:0;margin:0;padding:0}
    .radio-row{display:flex;gap:18px;align-items:center;margin-bottom:10px}
    .radio-group{display:flex;align-items:center;gap:10px;font-weight:600}
    .radio-group input[type="radio"]{accent-color:var(--brand);transform:scale(1.15)}

    .inline-hint{font-size:14px;margin-top:2px;color:var(--muted)}
    .inline-hint b{color:var(--ink)}

    .actions-grid{display:grid;grid-template-columns:1fr 1fr; gap:16px;margin:18px 0}
    @media (max-width:820px){.actions-grid{grid-template-columns:1fr}}
    .cta-card{
      border:2px solid var(--maroon-500); border-radius:var(--radius); padding:16px 16px 18px;
      position:relative; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.02);
      transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease;
      cursor:pointer; user-select:none;
    }
    .cta-card:hover{transform:translateY(-1px); box-shadow:var(--shadow); border-color:var(--brand)}
    .cta-title{font-weight:800;margin-bottom:6px}
    .cta-sub{color:var(--muted);font-size:14px}
    .cta-icon{
      position:absolute; right:12px; top:12px; width:22px; height:22px;
      border:2px solid var(--maroon-500); border-radius:6px; display:flex; align-items:center; justify-content:center;
      font-size:13px; font-weight:800; color:var(--maroon-500);
    }
    .cta-card:hover .cta-icon{border-color:var(--brand); color:var(--brand)}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:14px 18px; border:0; border-radius:999px;
         font-weight:700; cursor:pointer; background:var(--brand); color:white; box-shadow:var(--shadow)}
    .btn:hover{filter:brightness(0.98)}
    .btn.ghost{background:transparent; color:var(--brand); border:2px solid var(--brand); box-shadow:none; border-radius:var(--radius)}
    .btn.full{width:100%}
    .footer-actions{margin-top:24px; display:flex; gap:14px; flex-wrap:wrap}
    .footer-actions .btn:first-child{flex:1}
    .submit-wrap{display:flex; justify-content:flex-end; margin-top:14px}

    /* Dose progress */
    .meter-wrap{margin:18px 0 6px}
    .meter-label{font-weight:700; margin-bottom:8px}
    .meter{
      height:12px; width:100%; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid #ececec; position:relative;
    }
    .meter-fill{height:100%; width:0%; background:linear-gradient(90deg, var(--success), #1ea87b); transition:width .25s}
    .marker{position:absolute; top:-6px; bottom:-6px; width:2px; background:var(--maroon-500); left:calc(100% - 2px)}
    .marker::after{content:'Exact'; position:absolute; top:-22px; right:-16px; font-size:12px; color:var(--maroon-600); font-weight:700}
    .meter-under{color:var(--warning); font-weight:600; margin-top:8px; display:none}
    .meter-over{color:var(--danger); font-weight:600; margin-top:8px; display:none}

    .suggest{margin-top:8px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#f8fafc; border:1px dashed var(--border);
          border-radius:999px; cursor:pointer; font-weight:600}
    .pill:hover{background:#fff}
    .pill small{color:var(--muted); font-weight:500}

    /* Modals themed to maroon */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:50}
    .modal{width:min(820px, 92vw); background:#fff; border-radius:18px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,.22); border:3px solid var(--maroon-500)}
    .modal-head{background:var(--maroon-600); color:#fff; padding:16px 18px; display:flex; align-items:center; justify-content:space-between}
    .modal-title{font-size:18px; font-weight:800}
    .modal-body{padding:16px 18px; max-height:65vh; overflow:auto}
    .modal-foot{padding:14px 18px; background:#fafafa; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #eee}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th{font-size:13px; color:#6b7280; text-align:left; font-weight:700; padding:0 10px}
    td{background:#fff; border:1px solid #efefef; padding:10px 12px; border-radius:10px}
    tr:focus-within td{outline:3px solid rgba(154,34,49,.25)}

    .muted{color:var(--muted)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <div class="container">
    <div class="info-banner">Please review these details. If not correct, please call the MyeCare Program team on <b>1800 140 272</b>.</div>

    <!-- Prefilled, non-editable top fields -->
    <div class="grid cols-2 row">
      <div>
        <label for="physician">Treating physician’s name</label>
        <input id="physician" class="input readonly" value="Barry White" disabled />
      </div>
      <div>
        <label for="hospital">Hospital pharmacy’s name</label>
        <input id="hospital" class="input readonly" value="Magical Test Clinic" disabled />
      </div>
      <div>
        <label for="initials">Patient’s initials</label>
        <input id="initials" class="input readonly" value="PW" disabled />
      </div>
      <div>
        <label for="dob">Patient’s date of birth</label>
        <input id="dob" class="input readonly" value="28 / 06 / 1980" disabled />
      </div>
    </div>

    <div class="section-lead">Please answer the following question:</div>
    <div class="grid cols-2 row">
      <fieldset>
        <legend class="sr-only">Is the patient continuing on treatment?</legend>
        <div class="radio-row">
          <span style="font-weight:700">Is the patient continuing on treatment?</span>
          <label class="radio-group"><input type="radio" name="continuing" checked disabled /> Yes</label>
          <label class="radio-group"><input type="radio" name="continuing" disabled /> No</label>
        </div>
      </fieldset>
      <fieldset>
        <legend class="sr-only">Has the patient’s treatment been delayed?</legend>
        <div class="radio-row">
          <span style="font-weight:700">Has the patient’s treatment been delayed?</span>
          <label class="radio-group"><input type="radio" name="delayed" disabled /> Yes</label>
          <label class="radio-group"><input type="radio" name="delayed" checked disabled /> No</label>
        </div>
      </fieldset>
    </div>

    <!-- Prefilled dates, non-editable -->
    <div class="grid cols-2 row">
      <div>
        <label for="prev">What date did the previous infusion happen?*</label>
        <input id="prev" class="input readonly" value="15 / 09 / 2025" disabled />
      </div>
      <div>
        <label for="next">What date is the next infusion?*</label>
        <input id="next" class="input readonly" value="15 / 10 / 2025" disabled />
      </div>
    </div>

    <!-- Editable calculator inputs -->
    <div class="grid cols-2 row">
      <div>
        <label for="weight">Confirm patient’s weight*</label>
        <div style="display:flex; gap:10px">
          <input id="weight" class="input" type="number" step="0.1" min="0" placeholder="e.g. 86" aria-describedby="kg-unit" />
          <input id="kg-unit" class="input readonly" value="kg" style="max-width:90px;text-align:center" disabled />
        </div>
      </div>
      <div>
        <label for="dose">Confirm patient’s treatment dose*</label>
        <select id="dose" class="input">
          <option value="2.5" selected>2.50 mg/kg</option>
          <option value="1.9">1.90 mg/kg</option>
        </select>
      </div>
    </div>

    <!-- Inline exact dose w/ formula -->
    <div class="inline-hint" id="inlineHint" aria-live="polite" hidden>
      <b>TGA recommended dose:</b> Weight: <span id="wVal">–</span> × Dose: <span id="dVal">–</span> = <b id="exactMg2">–</b>
    </div>

    <!-- Vial counts (editable) -->
    <div class="grid cols-2 row">
      <div>
        <label for="v70">Number of 70mg vials</label>
        <input id="v70" class="input" type="number" min="0" step="1" value="0" />
      </div>
      <div>
        <label for="v100">Number of 100mg vials</label>
        <input id="v100" class="input" type="number" min="0" step="1" value="0" />
      </div>
    </div>

    <!-- Dose progress (visible once weight & dose are set) -->
    <div class="meter-wrap" aria-live="polite">
      <div class="meter-label">Dose progress</div>
      <div class="meter" id="meter">
        <div id="fill" class="meter-fill"></div>
        <div class="marker" id="marker" title="Exact dose"></div>
      </div>
      <div id="under" class="meter-under"></div>
      <div id="over" class="meter-over"></div>
    </div>

    <!-- Best option pill -->
    <div class="suggest" id="suggestWrap" style="display:none">
      <button id="bestPill" class="pill" type="button" aria-label="Apply best vial option">
        <span id="bestText">Best option</span>
      </button>
    </div>

    <!-- Action cards -->
    <div class="actions-grid">
      <div id="openCalcCard" class="cta-card" role="button" tabindex="0" aria-label="Open dose and vial calculator">
        <div class="cta-title">Dose and vial calculator</div>
        <div class="cta-sub">Use this calculator for guidance only</div>
        <div class="cta-icon">↗</div>
      </div>
      <a class="cta-card" href="https://www.tga.gov.au/resources/prescription-medicines-under-evaluation/blenrep-glaxosmithkline-australia-pty-ltd" target="_blank" rel="noopener" aria-label="View the TGA’s official guidance">
        <div class="cta-title">View the TGA’s official guidance</div>
        <div class="cta-sub">Review the TGA’s recommendations</div>
        <div class="cta-icon">↗</div>
      </a>
    </div>

    <div class="footer-actions">
      <button id="resetBtn" class="btn ghost" type="button">Reset</button>
    </div>

    <div class="submit-wrap">
      <button class="btn" type="button" id="submitBtn">Submit</button>
    </div>
  </div>

  <!-- Calculator modal -->
  <div id="calcModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="calcTitle">Dose & vial calculator</div>
        <button id="closeCalc" class="btn ghost" style="background:#fff;color:var(--brand);border-color:#fff">Close</button>
      </div>
      <div class="modal-body">
        <div class="muted" id="calcExactLine">Exact required dose: –</div>
        <div style="height:10px"></div>
        <table aria-label="Top vial options">
          <thead>
            <tr>
              <th>Option</th>
              <th>Total mg</th>
              <th>Over / Under</th>
              <th>Vial breakdown</th>
              <th><span class="sr-only">Pick</span></th>
            </tr>
          </thead>
          <tbody id="optionRows"></tbody>
        </table>
      </div>
      <div class="modal-foot">
        <button class="btn ghost" id="cancelCalc">Cancel</button>
        <button class="btn" id="applyCalc">Apply to form</button>
      </div>
    </div>
  </div>

  <!-- Confirm selection modal -->
  <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="confirmTitle">Confirm this vial option</div>
        <button id="closeConfirm" class="btn ghost" style="background:#fff;color:var(--brand);border-color:#fff">Close</button>
      </div>
      <div class="modal-body" id="confirmBody">
        <!-- dynamic content per user format -->
      </div>
      <div class="modal-foot">
        <button class="btn ghost" id="cancelConfirm">Cancel</button>
        <button class="btn" id="confirmApply">Confirm & apply</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const fmt2 = (n)=>Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    const fmt0 = (n)=>Number(n).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0});

    const weightEl = $('#weight');
    const doseEl = $('#dose');
    const v70El = $('#v70');
    const v100El = $('#v100');
    const fillEl = $('#fill');
    const markerEl = $('#marker');
    const underEl = $('#under');
    const overEl = $('#over');
    const exactEl2 = $('#exactMg2');
    const wVal = $('#wVal');
    const dVal = $('#dVal');
    const inlineHint = $('#inlineHint');
    const suggestWrap = $('#suggestWrap');
    const bestPill = $('#bestPill');
    const bestText = $('#bestText');

    const calcModal = $('#calcModal');
    const confirmModal = $('#confirmModal');
    const confirmBody = $('#confirmBody');
    const optionRows = $('#optionRows');
    const calcExactLine = $('#calcExactLine');
    const openCalcCard = $('#openCalcCard');
    const closeCalc = $('#closeCalc');
    const cancelCalc = $('#cancelCalc');
    const applyCalc = $('#applyCalc');
    const closeConfirm = $('#closeConfirm');
    const cancelConfirm = $('#cancelConfirm');
    const confirmApply = $('#confirmApply');

    let exact = 0;
    let pick = null;

    function calcExact(){
      const w = parseFloat(weightEl.value || 0);
      const d = parseFloat(doseEl.value || 0);
      exact = +(w*d).toFixed(2);
      if(w>0 && d>0){
        const dStr = fmt2(d);
        wVal.textContent = fmt2(w)+' kg';
        dVal.textContent = dStr+' mg/kg';
        exactEl2.textContent = fmt2(exact)+' mg';
        inlineHint.hidden = false;
        calcExactLine.textContent = 'Exact required dose: '+fmt2(exact)+' mg';
      }else{
        wVal.textContent = '–';
        dVal.textContent='–';
        exactEl2.textContent='–';
        inlineHint.hidden = true;
        calcExactLine.textContent = 'Exact required dose: –';
      }
    }

    function percentWaste(delta){ if(exact<=0) return 0; return Math.abs(delta)/exact*100; }

    function updateBar(){
      const a = parseInt(v70El.value||0,10);
      const b = parseInt(v100El.value||0,10);
      const total = a*70 + b*100;
      const haveInputs = parseFloat(weightEl.value||0)>0 && parseFloat(doseEl.value||0)>0;

      if(!haveInputs){
        fillEl.style.width = '0%';
        underEl.style.display='none';
        overEl.style.display='none';
        suggestWrap.style.display='none';
        return;
      }

      // Fill is relative to exact (target marker at 100%); cap to 140% width.
      const ratio = Math.min((exact>0 ? total/exact : 0), 1.4);
      fillEl.style.width = (Math.max(0, ratio)*100)+'%';
      const delta = +(total - exact).toFixed(2);

      underEl.style.display='none';
      overEl.style.display='none';

      if(delta < -0.005){
        underEl.textContent = '⬇ Under by: ' + fmt2(Math.abs(delta)) + ' mg • Advisory only. Verify with PI / local policy.';
        underEl.style.display='block';
      }else if(delta > 0.005){
        const pct = percentWaste(delta);
        overEl.textContent = '⬆ Over by: ' + fmt2(delta) + ' mg ('+fmt2(pct)+'%)';
        overEl.style.display='block';
      }else{
        overEl.textContent = 'Exact match';
        overEl.style.display='block';
      }

      // Suggested best
      const best = bestOption();
      if(best){
        const over = best.total - exact;
        const pct = percentWaste(over);
        suggestWrap.style.display='block';
        bestText.textContent = 'Need ' + fmt2(exact) + ' mg → ' + compText(best.a,best.b) + ' = ' + best.total + ' mg • ' + (over>=0? 'Over +' : 'Under ') + fmt2(Math.abs(over)) + ' mg ('+fmt2(pct)+'%)';
        bestPill.onclick = ()=>{ pick = best; openConfirm(best); };
      }else{
        suggestWrap.style.display='none';
      }
    }

    function compText(a,b){
      const parts=[]; if(a>0) parts.push('70×'+a); if(b>0) parts.push('100×'+b); return parts.join(' + ');
    }

    function bestOption(){
      if(exact<=0) return null;
      let best=null;
      const max70 = Math.ceil((exact+100)/70)+2;
      const max100 = Math.ceil((exact+100)/100)+2;
      for(let a=0; a<=max70; a++){
        for(let b=0; b<=max100; b++){
          if(a+b===0) continue;
          const total = a*70 + b*100;
          const over = total - exact;
          const metric = over>=0 ? over : Math.abs(over)+1000;
          const cand = {a,b,total,over};
          if(!best || metric < (best.over>=0 ? best.over : Math.abs(best.over)+1000) || (metric=== (best.over>=0 ? best.over : Math.abs(best.over)+1000) && (a+b) < (best.a+best.b))){
            best = cand;
          }
        }
      }
      return best;
    }

    // Calculator modal
    function openCalc(){ renderOptions(); calcModal.style.display='flex'; }
    function closeCalcModal(){ calcModal.style.display='none'; }
    function openConfirm(sel){
      // Build the descriptive block as requested
      const w = parseFloat(weightEl.value||0);
      const d = parseFloat(doseEl.value||0);
      const doseLine = fmt2(d)+' mg/kg regimen';
      const calcLine = fmt2(d)+' mg/kg × '+fmt2(w)+' kg = '+fmt2(exact)+' mg';
      const comp = compText(sel.a, sel.b) + ' = ' + sel.total + ' mg';
      const over = sel.total - exact;
      const pct = percentWaste(over);
      const wasteLine = 'Dose = ' + fmt2(exact) + ' mg • Waste ' + fmt2(Math.abs(over)) + ' mg (' + fmt2(pct) + '%)';
      confirmBody.innerHTML = `
        <h3 style="margin:0 0 8px 0">Suggested Vial Composition</h3>
        <div class="muted">Patient weight: <b>${fmt2(w)} kg</b></div>
        <div class="muted">Selected regimen: <b>${doseLine}</b></div>
        <div class="muted">Calculation: ${calcLine}</div>
        <div style="height:10px"></div>
        <h3 style="margin:0 0 8px 0">Suggested Vial Composition</h3>
        <div><b>Suggestion:</b> ${comp}</div>
        <div><b>${wasteLine}</b></div>
        <div class="muted" style="margin-top:8px"><b>Leftover product cannot be re-used per TGA guidelines.</b></div>
      `;
      confirmModal.style.display='flex';
    }
    function closeConfirmModal(){ confirmModal.style.display='none'; }

    function renderOptions(){
      optionRows.innerHTML='';
      calcExact();
      const rows=[];
      const max70 = Math.ceil((exact+100)/70)+2;
      const max100 = Math.ceil((exact+100)/100)+2;
      for(let a=0; a<=max70; a++){
        for(let b=0; b<=max100; b++){
          if(a+b===0) continue;
          const total = a*70 + b*100;
          const over = +(total - exact).toFixed(2);
          const waste = over>=0 ? over : Number.POSITIVE_INFINITY;
          rows.push({a,b,total,over,waste});
        }
      }
      rows.sort((r1,r2)=>{
        const f1 = (r1.waste===Infinity)?1:0, f2 = (r2.waste===Infinity)?1:0;
        if(f1!==f2) return f1-f2;
        if(r1.waste!==r2.waste) return r1.waste-r2.waste;
        const n1=r1.a+r1.b, n2=r2.a+r2.b;
        if(n1!==n2) return n1-n2;
        return r1.total-r2.total;
      });
      const top = rows.slice(0, 6);
      top.forEach((r,i)=>{
        const tr = document.createElement('tr');
        const overTxt = r.over>=0? ('+'+fmt2(r.over)+' mg ('+fmt2(percentWaste(r.over))+'%)') : (fmt2(r.over)+' mg');
        tr.innerHTML = `
          <td><b>${i===0?'Recommended':'Option ' + (i+1)}</b></td>
          <td>${r.total} mg</td>
          <td>${overTxt}</td>
          <td>${compText(r.a,r.b)}</td>
          <td><button class="btn ghost" data-i="${i}">Select</button></td>
        `;
        optionRows.appendChild(tr);
      });
      optionRows.querySelectorAll('button').forEach((btn,idx)=>{
        btn.addEventListener('click',()=>{
          const r = top[idx];
          pick = r;
          openConfirm(r);
        });
      });
    }

    function applySelection(){
      if(!pick) return;
      v70El.value = pick.a;
      v100El.value = pick.b;
      updateBar();
    }

    [weightEl, doseEl].forEach(el=>el.addEventListener('input', ()=>{ calcExact(); updateBar(); }));
    [v70El, v100El].forEach(el=>el.addEventListener('input', updateBar));

    $('#resetBtn').addEventListener('click', ()=>{
      weightEl.value=''; doseEl.value='2.5'; v70El.value='0'; v100El.value='0'; exact=0;
      calcExact(); updateBar();
    });

    openCalcCard.addEventListener('click', openCalc);
    openCalcCard.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') openCalc(); });
    closeCalc.addEventListener('click', ()=>calcModal.style.display='none');
    cancelCalc.addEventListener('click', ()=>calcModal.style.display='none');
    applyCalc.addEventListener('click', ()=>{
      if(!pick){
        const best = bestOption();
        if(best){ pick = best; }
      }
      if(pick){ openConfirm(pick); calcModal.style.display='none'; }
    });

    closeConfirm.addEventListener('click', closeConfirmModal);
    cancelConfirm.addEventListener('click', closeConfirmModal);
    confirmApply.addEventListener('click', ()=>{ applySelection(); closeConfirmModal(); });

    $('#submitBtn').addEventListener('click', ()=>{ alert('Submit clicked. (Prototype)'); });

    // Init
    calcExact();
    updateBar();
  </script>
</body>
</html>
