<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyECare — Dose & Vial Calculator (Merged Mock v3)</title>
  <style>
    :root{
      --maroon-900:#5d0e17;
      --maroon-800:#6d121e;
      --maroon-700:#7d1624;
      --maroon-600:#8a1b2a;
      --maroon-500:#9a2231;
      --maroon-400:#b23340;
      --brand: var(--maroon-600);
      --ink:#1d1d1f;
      --muted:#6b7280;
      --bg:#ffffff;
      --card:#fafafa;
      --border:#e6e6e6;
      --radius:14px;
      --radius-sm:10px;
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --focus:0 0 0 3px rgba(154,34,49,.25);
      --danger:#b91c1c;
      --success:#167c3a;
      --warning:#b45309;
      --yellow:#eab308;
      --red:#ef4444;
      --green:#16a34a;
    }
    *{box-sizing:border-box}
    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
         margin:0;background:var(--bg);color:var(--ink);}
    h1,h2,h3{margin:0 0 .5rem 0}
    .container{max-width:980px;margin:36px auto;padding:0 16px}

    .info-banner{color:var(--brand);font-weight:700;margin-bottom:22px}

    .grid{display:grid;gap:18px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width: 820px){.grid.cols-2{grid-template-columns:1fr}}

    label{display:block;font-weight:600;margin:2px 0 8px 2px}
    .input, select, .date-input{
      width:100%; border:1px solid var(--border); padding:14px 14px;
      border-radius:var(--radius); background:#f7f7f8; color:var(--ink);
      outline:none; transition:border .15s, box-shadow .15s;
    }
    .input:focus, select:focus, .date-input:focus{border-color:var(--maroon-400); box-shadow:var(--focus); background:#fff}
    .readonly, .input[disabled], select[disabled]{color:#8e8e93;background:#f3f4f6;border-color:#ececec;cursor:not-allowed}
    .row{margin-bottom:18px}
    .section-lead{font-size:18px;font-weight:700;color:var(--brand);margin:8px 0 8px}

    fieldset{border:0;margin:0;padding:0}
    .radio-row{display:flex;gap:18px;align-items:center;margin-bottom:10px}
    .radio-group{display:flex;align-items:center;gap:10px;font-weight:600}
    .radio-group input[type="radio"]{accent-color:var(--brand);transform:scale(1.15)}

    .inline-hint{font-size:14px;margin-top:2px;color:var(--muted)}
    .inline-hint b{color:var(--ink)}

    .actions-grid{display:grid;grid-template-columns:1fr 1fr; gap:16px;margin:18px 0}
    @media (max-width:820px){.actions-grid{grid-template-columns:1fr}}
    .cta-card{
      border:2px solid var(--maroon-500); border-radius:var(--radius); padding:16px 16px 18px;
      position:relative; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.02);
      transition:transform .08s ease, box-shadow .15s ease, border-color .15s ease;
      cursor:pointer; user-select:none;
    }
    .cta-card:hover{transform:translateY(-1px); box-shadow:var(--shadow); border-color:var(--brand)}
    .cta-title{font-weight:800;margin-bottom:6px}
    .cta-sub{color:var(--muted);font-size:14px}
    .cta-icon{
      position:absolute; right:12px; top:12px; width:22px; height:22px;
      border:2px solid var(--maroon-500); border-radius:6px; display:flex; align-items:center; justify-content:center;
      font-size:13px; font-weight:800; color:var(--maroon-500);
    }
    .cta-card:hover .cta-icon{border-color:var(--brand); color:var(--brand)}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:14px 18px; border:0; border-radius:999px;
         font-weight:700; cursor:pointer; background:var(--brand); color:white; box-shadow:var(--shadow)}
    .btn:hover{filter:brightness(0.98)}
    .btn.ghost{background:transparent; color:var(--brand); border:2px solid var(--brand); box-shadow:none; border-radius:var(--radius)}
    .btn.full{width:100%}
    .footer-actions{margin-top:24px; display:flex; gap:14px; flex-wrap:wrap}
    .footer-actions .btn:first-child{flex:1}
    .submit-wrap{display:flex; justify-content:flex-end; margin-top:14px}

    /* Dose progress */
    .meter-wrap{margin:18px 0 6px; display:none}
    .meter-label{font-weight:700; margin-bottom:8px}
    .meter{
      height:14px; width:100%; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid #ececec; position:relative;
    }
    .meter-fill{height:100%; width:0%; transition:width .25s}
    .fill-base{background:linear-gradient(90deg,#1f2937,#111827)}
    .fill-green{background:linear-gradient(90deg, #19b36c, #1ea87b)}
    .fill-yellow{background:linear-gradient(90deg, #facc15, #eab308)}
    .fill-red{background:linear-gradient(90deg, #f43f5e, #ef4444)}

    .marker{position:absolute; top:-6px; bottom:-6px; width:2px; background:var(--maroon-500); left:calc(75% - 1px)}
    .marker-label{position:absolute; top:-26px; left:75%; transform:translateX(-50%); font-size:12px; color:var(--maroon-600); font-weight:700}

    .meter-info{margin-top:8px; font-weight:600}
    .meter-under{color:var(--warning); font-weight:600; margin-top:6px; display:none}
    .meter-over{color:var(--danger); font-weight:600; margin-top:6px; display:none}

    .waste-key{display:flex; gap:10px; align-items:center; font-size:12px; color:var(--muted); margin-top:8px}
    .key-dot{width:12px; height:12px; border-radius:999px; display:inline-block}
    .key-green{background:#19b36c}
    .key-yellow{background:#eab308}
    .key-red{background:#ef4444}

    .suggest{margin-top:8px}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#f8fafc; border:1px dashed var(--border);
          border-radius:999px; cursor:pointer; font-weight:600}
    .pill:hover{background:#fff}
    .pill small{color:var(--muted); font-weight:500}

    /* Modals themed to maroon */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; align-items:center; justify-content:center; z-index:50}
    .modal{width:min(820px, 92vw); background:#fff; border-radius:18px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,.22); border:3px solid var(--maroon-500)}
    .modal-head{background:var(--maroon-600); color:#fff; padding:16px 18px; display:flex; align-items:center; justify-content:space-between}
    .modal-title{font-size:18px; font-weight:800}
    .modal-body{padding:16px 18px; max-height:65vh; overflow:auto}
    .modal-foot{padding:14px 18px; background:#fafafa; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #eee}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th{font-size:13px; color:#6b7280; text-align:left; font-weight:700; padding:0 10px}
    td{background:#fff; border:1px solid #efefef; padding:10px 12px; border-radius:10px; transition:background-color .15s, border-color .15s}
    tr.waste-tier-low td{background:rgba(22,124,58,.08); border-color:rgba(22,124,58,.3)}
    tr.waste-tier-mid td{background:rgba(234,179,8,.12); border-color:rgba(234,179,8,.32)}
    tr.waste-tier-high td{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.32)}
    tr.waste-tier-under td{background:rgba(107,114,128,.12); border-color:rgba(107,114,128,.28)}
    tr:focus-within td{outline:3px solid rgba(154,34,49,.25)}

    .muted{color:var(--muted)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <div class="container">
    <div class="info-banner">Please review these details. If not correct, please call the MyeCare Program team on <b>1800 140 272</b>.</div>

    <!-- Prefilled, non-editable top fields -->
    <div class="grid cols-2 row">
      <div>
        <label for="physician">Treating physician’s name</label>
        <input id="physician" class="input readonly" value="Barry White" disabled />
      </div>
      <div>
        <label for="hospital">Hospital pharmacy’s name</label>
        <input id="hospital" class="input readonly" value="Magical Test Clinic" disabled />
      </div>
      <div>
        <label for="initials">Patient’s initials</label>
        <input id="initials" class="input readonly" value="PW" disabled />
      </div>
      <div>
        <label for="dob">Patient’s date of birth</label>
        <input id="dob" class="input readonly" value="28 / 06 / 1980" disabled />
      </div>
    </div>

    <div class="section-lead">Please answer the following question:</div>
    <div class="grid cols-2 row">
      <fieldset>
        <legend class="sr-only">Is the patient continuing on treatment?</legend>
        <div class="radio-row">
          <span style="font-weight:700">Is the patient continuing on treatment?</span>
          <label class="radio-group"><input type="radio" name="continuing" checked disabled /> Yes</label>
          <label class="radio-group"><input type="radio" name="continuing" disabled /> No</label>
        </div>
      </fieldset>
      <fieldset>
        <legend class="sr-only">Has the patient’s treatment been delayed?</legend>
        <div class="radio-row">
          <span style="font-weight:700">Has the patient’s treatment been delayed?</span>
          <label class="radio-group"><input type="radio" name="delayed" disabled /> Yes</label>
          <label class="radio-group"><input type="radio" name="delayed" checked disabled /> No</label>
        </div>
      </fieldset>
    </div>

    <!-- Prefilled dates, non-editable -->
    <div class="grid cols-2 row">
      <div>
        <label for="prev">What date did the previous infusion happen?*</label>
        <input id="prev" class="input readonly" value="15 / 09 / 2025" disabled />
      </div>
      <div>
        <label for="next">What date is the next infusion?*</label>
        <input id="next" class="input readonly" value="15 / 10 / 2025" disabled />
      </div>
    </div>

    <!-- Editable calculator inputs -->
    <div class="grid cols-2 row">
      <div>
        <label for="weight">Confirm patient’s weight*</label>
        <div style="display:flex; gap:10px">
          <input id="weight" class="input" type="number" step="0.1" min="0" placeholder="e.g. 86" aria-describedby="kg-unit" />
          <input id="kg-unit" class="input readonly" value="kg" style="max-width:90px;text-align:center" disabled />
        </div>
      </div>
      <div>
        <label for="dose">Confirm patient’s treatment dose*</label>
        <select id="dose" class="input">
          <option value="" selected>Select dose</option>
          <option value="2.5">2.50 mg/kg</option>
          <option value="1.9">1.90 mg/kg</option>
        </select>
      </div>
    </div>

    <!-- Inline TGA formula (hidden until both inputs provided) -->
    <div class="inline-hint" id="inlineHint" aria-live="polite" style="display:none">
      TGA recommended dose: Weight: <span id="wVal">–</span> × Dose: <span id="dVal">–</span> = <b id="exactSum">–</b>
    </div>

    <!-- Vial counts (editable) -->
    <div class="grid cols-2 row">
      <div>
        <label for="v70">Number of 70mg vials</label>
        <input id="v70" class="input" type="number" min="0" step="1" value="0" />
      </div>
      <div>
        <label for="v100">Number of 100mg vials</label>
        <input id="v100" class="input" type="number" min="0" step="1" value="0" />
      </div>
    </div>

    <!-- Best option pill (now above dose progress) -->
    <div class="suggest" id="suggestWrap" style="display:none">
      <button id="bestPill" class="pill" type="button" aria-label="Apply best vial option">
        <span id="bestText">Dose required: –</span>
      </button>
    </div>

    <!-- Dose progress (visible only once weight & dose are set) -->
    <div class="meter-wrap" id="meterWrap" aria-live="polite">
      <div class="meter-label">Dose progress</div>
      <div class="meter" id="meter">
        <div id="fill" class="meter-fill fill-base"></div>
        <div class="marker" id="marker" title="Exact dose"></div>
        <div class="marker-label" id="markerLabel">Exact –</div>
      </div>
      <div id="tgaLine" class="meter-info"></div>
      <div id="under" class="meter-under"></div>
      <div id="over" class="meter-over"></div>
      <div class="waste-key" id="wasteKey" style="display:none">
        <span class="key-dot key-green"></span> &lt; 25% waste
        <span class="key-dot key-yellow"></span> 25–50% waste
        <span class="key-dot key-red"></span> &gt; 50% waste
      </div>
    </div>

    <!-- Action cards -->
    <div class="actions-grid">
      <div id="openCalcCard" class="cta-card" role="button" tabindex="0" aria-label="Open dose and vial calculator">
        <div class="cta-title">Dose and vial calculator</div>
        <div class="cta-sub">Use this calculator for guidance only</div>
        <div class="cta-icon">↗</div>
      </div>
      <a class="cta-card" href="https://www.tga.gov.au/resources/prescription-medicines-under-evaluation/blenrep-glaxosmithkline-australia-pty-ltd" target="_blank" rel="noopener" aria-label="View the TGA’s official guidance">
        <div class="cta-title">View the TGA’s official guidance</div>
        <div class="cta-sub">Review the TGA’s recommendations</div>
        <div class="cta-icon">↗</div>
      </a>
    </div>

    <div class="footer-actions">
      <button id="resetBtn" class="btn ghost" type="button">Reset</button>
    </div>

    <div class="submit-wrap">
      <button class="btn" type="button" id="submitBtn">Submit</button>
    </div>
  </div>

  <!-- Calculator modal -->
  <div id="calcModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="calcTitle">Dose & vial calculator</div>
        <button id="closeCalc" class="btn ghost" style="background:#fff;color:var(--brand);border-color:#fff">Close</button>
      </div>
      <div class="modal-body">
        <div class="grid cols-2 row">
          <div>
            <label for="modalWeight">Confirm patient’s weight*</label>
            <div style="display:flex; gap:10px">
              <input id="modalWeight" class="input" type="number" step="0.1" min="0" placeholder="e.g. 86" aria-describedby="modalKgUnit" />
              <input id="modalKgUnit" class="input readonly" value="kg" style="max-width:90px;text-align:center" disabled />
            </div>
          </div>
          <div>
            <label for="modalDose">Confirm patient’s treatment dose*</label>
            <select id="modalDose" class="input">
              <option value="" selected>Select dose</option>
              <option value="2.5">2.50 mg/kg</option>
              <option value="1.9">1.90 mg/kg</option>
            </select>
          </div>
        </div>
        <div class="muted" id="calcExactLine">Set weight and dose to view options. Exact required dose: 0.00 mg</div>
        <div style="height:10px"></div>
        <table aria-label="Top vial options">
          <thead>
            <tr>
              <th>Waste tier</th>
              <th>Total mg</th>
              <th>Over / Under</th>
              <th>Vial breakdown</th>
              <th><span class="sr-only">Pick</span></th>
            </tr>
          </thead>
          <tbody id="optionRows"></tbody>
        </table>
      </div>
      <div class="modal-foot">
        <button class="btn ghost" id="cancelCalc">Cancel</button>
        <button class="btn" id="applyCalc">Apply to form</button>
      </div>
    </div>
  </div>

  <!-- Confirm selection modal -->
  <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="confirmTitle">Confirm this vial option</div>
        <button id="closeConfirm" class="btn ghost" style="background:#fff;color:var(--brand);border-color:#fff">Close</button>
      </div>
      <div class="modal-body" id="confirmBody">
        <!-- dynamic content per user format -->
      </div>
      <div class="modal-foot">
        <button class="btn ghost" id="cancelConfirm">Cancel</button>
        <button class="btn" id="confirmApply">Confirm & apply</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const fmt2 = (n)=>Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    const fmt0 = (n)=>Number(n).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0});

    const weightEl = $('#weight');
    const doseEl = $('#dose');
    const v70El = $('#v70');
    const v100El = $('#v100');
    const meterWrap = $('#meterWrap');
    const fillEl = $('#fill');
    const markerEl = $('#marker');
    const markerLabel = $('#markerLabel');
    const underEl = $('#under');
    const overEl = $('#over');
    const tgaLine = $('#tgaLine');
    const inlineHint = $('#inlineHint');
    const exactSum = $('#exactSum');
    const wVal = $('#wVal');
    const dVal = $('#dVal');
    const wasteKey = $('#wasteKey');

    const suggestWrap = $('#suggestWrap');
    const bestPill = $('#bestPill');
    const bestText = $('#bestText');

    const calcModal = $('#calcModal');
    const modalWeightEl = $('#modalWeight');
    const modalDoseEl = $('#modalDose');
    const confirmModal = $('#confirmModal');
    const confirmBody = $('#confirmBody');
    const optionRows = $('#optionRows');
    const calcExactLine = $('#calcExactLine');
    const openCalcCard = $('#openCalcCard');
    const closeCalc = $('#closeCalc');
    const cancelCalc = $('#cancelCalc');
    const applyCalc = $('#applyCalc');
    const closeConfirm = $('#closeConfirm');
    const cancelConfirm = $('#cancelConfirm');
    const confirmApply = $('#confirmApply');

    let exact = 0;
    let pick = null;
    let modalActive = false;
    let lastInputs = {w:0,d:0,source:'main'};
    let confirmContext = null;

    function getWeightDose({preferModal=false}={}){
      const useModal = preferModal && modalActive;
      const weight = parseFloat((useModal ? modalWeightEl.value : weightEl.value) || 0);
      const dose = parseFloat((useModal ? modalDoseEl.value : doseEl.value) || 0);
      return {w: isFinite(weight)?weight:0, d: isFinite(dose)?dose:0, source: useModal ? 'modal' : 'main'};
    }

    function haveInputs({inputs, preferModal=false}={}){
      const data = inputs || getWeightDose({preferModal});
      return (data.w>0 && data.d>0);
    }

    function calcExact({preferModal=false}={}){
      const inputs = getWeightDose({preferModal});
      const {w,d} = inputs;
      exact = +(Number.isFinite(w*d) ? (w*d).toFixed(2) : 0);
      lastInputs = inputs;
      if(haveInputs({inputs})){
        const dStr = fmt2(d);
        wVal.textContent = fmt2(w)+' kg';
        dVal.textContent = dStr+' mg/kg';
        exactSum.textContent = fmt2(exact)+' mg';
        inlineHint.style.display = 'block';
      }else{
        wVal.textContent = '–';
        dVal.textContent = '–';
        exactSum.textContent = '–';
        inlineHint.style.display = 'none';
      }
      return inputs;
    }

    function percentWaste(delta, baseExact = exact){ if(baseExact<=0) return 0; return Math.abs(delta)/baseExact*100; }

    function setFillClass(pct){
      fillEl.classList.remove('fill-green','fill-yellow','fill-red');
      if(pct==null) return;
      if(pct < 25){ fillEl.classList.add('fill-green'); }
      else if(pct <= 50){ fillEl.classList.add('fill-yellow'); }
      else { fillEl.classList.add('fill-red'); }
    }

    function updateBar(){
      const a = parseInt(v70El.value||0,10);
      const b = parseInt(v100El.value||0,10);
      const total = a*70 + b*100;
      const {w,d} = getWeightDose();

      if(!haveInputs()){
        fillEl.style.width = '0%';
        underEl.style.display='none';
        overEl.style.display='none';
        tgaLine.textContent = '';
        markerLabel.textContent = 'Exact –';
        meterWrap.style.display='none';
        suggestWrap.style.display='none';
        wasteKey.style.display='none';
        setFillClass(null);
        return;
      }

      // Show the meter section
      meterWrap.style.display='block';
      wasteKey.style.display='flex';
      markerLabel.textContent = 'Exact ' + fmt2(exact) + ' mg';
      tgaLine.textContent = 'TGA recommended dose: Weight: ' + fmt2(w) + ' kg × Dose: ' + fmt2(d) + ' mg/kg = ' + fmt2(exact) + ' mg';

      // Fill is relative to exact; map 100% of the dose to ~75% of the bar and
      // use the remaining 25% to represent overfill (clamped to the container width).
      const ratio = exact>0 ? total/exact : 0;
      const safeRatio = Math.max(0, ratio);
      let fillPct;
      if(safeRatio <= 1){
        fillPct = safeRatio * 75;
      }else{
        const overRatio = Math.min(safeRatio - 1, 1);
        fillPct = 75 + (overRatio * 25);
      }
      fillEl.style.width = fillPct + '%';
      const delta = +(total - exact).toFixed(2);

      underEl.style.display='none';
      overEl.style.display='none';

      if(delta < -0.005){
        underEl.textContent = '⬇ Under by: ' + fmt2(Math.abs(delta)) + ' mg';
        underEl.style.display='block';
        setFillClass(null);
      }else if(delta > 0.005){
        const pct = percentWaste(delta);
        overEl.textContent = '⬆ Over by: ' + fmt2(delta) + ' mg ('+fmt2(pct)+'%)';
        overEl.style.display='block';
        wasteKey.style.display='flex';
        setFillClass(pct);
      }else{
        overEl.textContent = 'Exact match';
        overEl.style.display='block';
        setFillClass(null);
      }

      // Suggested best (pill)
      const best = bestOption();
      if(best){
        const over = +(best.total - exact).toFixed(2);
        const pct = percentWaste(over);
        suggestWrap.style.display='block';
        const comp = compText(best.a,best.b) + ' = ' + best.total + ' mg';
        bestText.textContent = 'Dose required: ' + fmt2(exact) + ' mg — ' + comp + ' • ' + (over>=0? 'Over +' : 'Under ') + fmt2(Math.abs(over)) + ' mg ('+fmt2(pct)+'%)';
        bestPill.onclick = ()=>{ pick = best; openConfirm(best); };
      }else{
        suggestWrap.style.display='none';
      }
    }

    function compText(a,b){
      const parts=[]; if(a>0) parts.push('70×'+a); if(b>0) parts.push('100×'+b); return parts.join(' + ');
    }

    function bestOption(){
      if(exact<=0) return null;
      let best=null;
      const max70 = Math.ceil((exact+100)/70)+2;
      const max100 = Math.ceil((exact+100)/100)+2;
      for(let a=0; a<=max70; a++){
        for(let b=0; b<=max100; b++){
          if(a+b===0) continue;
          const total = a*70 + b*100;
          const over = total - exact;
          const metric = over>=0 ? over : Math.abs(over)+1000;
          const cand = {a,b,total,over};
          if(!best || metric < (best.over>=0 ? best.over : Math.abs(best.over)+1000) || (metric=== (best.over>=0 ? best.over : Math.abs(best.over)+1000) && (a+b) < (best.a+best.b))){
            best = cand;
          }
        }
      }
      return best;
    }

    // Calculator modal
    function openCalc(){
      modalActive = true;
      pick = null;
      modalWeightEl.value = weightEl.value;
      modalDoseEl.value = doseEl.value;
      calcModal.style.display='flex';
      renderOptions();
    }
    function closeCalcModal({preserveExact=false}={}){
      modalActive = false;
      calcModal.style.display='none';
      if(!preserveExact){
        calcExact();
      }
    }
    function openConfirm(sel, inputs){
      const ctx = inputs ? {...inputs} : {...lastInputs};
      const targetExact = exact;
      confirmContext = {...ctx, exact: targetExact};
      // Build the descriptive block
      const w = ctx.w;
      const d = ctx.d;
      const doseLine = fmt2(d)+' mg/kg regimen';
      const calcLine = fmt2(d)+' mg/kg × '+fmt2(w)+' kg = '+fmt2(targetExact)+' mg';
      const comp = compText(sel.a, sel.b) + ' = ' + sel.total + ' mg';
      const over = +(sel.total - targetExact).toFixed(2);
      const pct = percentWaste(over, targetExact);
      const wasteLine = 'Dose = ' + fmt2(targetExact) + ' mg • ' + (over>=0? 'Waste ' : 'Shortfall ') + fmt2(Math.abs(over)) + ' mg (' + fmt2(pct) + '%)';
      confirmBody.innerHTML = `
        <h3 style="margin:0 0 8px 0">Suggested Vial Composition</h3>
        <div class="muted">Patient weight: <b>${fmt2(w)} kg</b></div>
        <div class="muted">Selected regimen: <b>${doseLine}</b></div>
        <div class="muted">Calculation: ${calcLine}</div>
        <div style="height:10px"></div>
        <div><b>Suggestion:</b> ${comp}</div>
        <div><b>${wasteLine}</b></div>
      `;
      confirmModal.style.display='flex';
    }
    function closeConfirmModal({refreshMain=false}={}){
      confirmModal.style.display='none';
      confirmContext = null;
      if(refreshMain){
        calcExact();
        updateBar();
      }
    }

    function renderOptions(){
      optionRows.innerHTML='';
      const inputs = calcExact({preferModal:true});
      if(!haveInputs({inputs})){
        calcExactLine.textContent = 'Set weight and dose to view options. Exact required dose: 0.00 mg';
        return;
      }
      calcExactLine.textContent = 'Exact required dose: ' + fmt2(exact) + ' mg';

      // Build candidate rows
      const rows=[];
      const max70 = Math.ceil((exact+100)/70)+2;
      const max100 = Math.ceil((exact+100)/100)+2;
      for(let a=0; a<=max70; a++){
        for(let b=0; b<=max100; b++){
          if(a+b===0) continue;
          const total = a*70 + b*100;
          const over = +(total - exact).toFixed(2);
          rows.push({a,b,total,over});
        }
      }

      const describeTier = (row)=>{
        const pct = percentWaste(row.over);
        if(row.over < 0){
          return {tier:'under', label:'Under dose'};
        }
        if(pct < 25){
          return {tier:'low', label:'<25% waste'};
        }
        if(pct <= 50){
          return {tier:'mid', label:'25–50% waste'};
        }
        return {tier:'high', label:'>50% waste'};
      };

      const sortedRows = rows
        .map((row)=>{
          const pct = percentWaste(row.over);
          const tierInfo = describeTier(row);
          return {...row, wastePct:pct, tier:tierInfo.tier, tierLabel:tierInfo.label, isUnder:row.over<0};
        })
        .sort((a,b)=>{
          if(a.isUnder !== b.isUnder){
            return a.isUnder ? 1 : -1;
          }
          if(!a.isUnder && !b.isUnder){
            if(a.wastePct !== b.wastePct){
              return a.wastePct - b.wastePct;
            }
          }else{
            const aAbs = Math.abs(a.over);
            const bAbs = Math.abs(b.over);
            if(aAbs !== bAbs){
              return aAbs - bAbs;
            }
          }
          const aCount = a.a + a.b;
          const bCount = b.a + b.b;
          if(aCount !== bCount){
            return aCount - bCount;
          }
          return a.total - b.total;
        });

      sortedRows.forEach((row,i)=>{
        const tr = document.createElement('tr');
        tr.classList.add('waste-tier-' + row.tier);
        const pctTxt = fmt2(row.wastePct);
        const overTxt = row.over>=0
          ? `Waste +${fmt2(row.over)} mg (${pctTxt}%)`
          : `Shortfall ${fmt2(Math.abs(row.over))} mg (${pctTxt}%)`;
        tr.innerHTML = `
          <td><b>${row.tierLabel}</b></td>
          <td>${row.total} mg</td>
          <td>${overTxt}</td>
          <td>${compText(row.a,row.b)}</td>
          <td><button class="btn ghost" data-i="${i}">Select</button></td>
        `;
        optionRows.appendChild(tr);
      });

      optionRows.querySelectorAll('button').forEach((btn)=>{
        btn.addEventListener('click',()=>{
          const idx = Number(btn.dataset.i);
          const sel = sortedRows[idx];
          pick = sel;
          const ctx = calcExact({preferModal:true});
          openConfirm(sel, ctx);
        });
      });
    }

    function applySelection(){
      if(!pick) return;
      if(confirmContext){
        const {w,d} = confirmContext;
        if(w>0){ weightEl.value = w; }
        if(d>0){ doseEl.value = String(d); }
        modalWeightEl.value = weightEl.value;
        modalDoseEl.value = doseEl.value;
      }
      v70El.value = pick.a;
      v100El.value = pick.b;
      calcExact();
      updateBar();
      pick = null;
    }

    [weightEl, doseEl].forEach(el=>el.addEventListener('input', ()=>{ calcExact(); updateBar(); }));
    [modalWeightEl, modalDoseEl].forEach(el=>{
      const refreshOptions = ()=>{ modalActive = true; pick = null; renderOptions(); };
      el.addEventListener('input', refreshOptions);
      el.addEventListener('change', refreshOptions);
    });
    [v70El, v100El].forEach(el=>el.addEventListener('input', updateBar));

    $('#resetBtn').addEventListener('click', ()=>{
      weightEl.value=''; doseEl.value=''; v70El.value='0'; v100El.value='0'; exact=0;
      modalWeightEl.value=''; modalDoseEl.value='';
      pick = null;
      confirmContext = null;
      calcExact(); updateBar();
    });

    openCalcCard.addEventListener('click', openCalc);
    openCalcCard.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') openCalc(); });
    closeCalc.addEventListener('click', ()=>closeCalcModal());
    cancelCalc.addEventListener('click', ()=>closeCalcModal());
    applyCalc.addEventListener('click', ()=>{
      const inputs = calcExact({preferModal:true});
      if(!pick){
        const best = bestOption();
        if(best){ pick = best; }
      }
      if(pick){ openConfirm(pick, inputs); closeCalcModal({preserveExact:true}); }
    });

    closeConfirm.addEventListener('click', ()=>closeConfirmModal({refreshMain:!modalActive}));
    cancelConfirm.addEventListener('click', ()=>closeConfirmModal({refreshMain:!modalActive}));
    confirmApply.addEventListener('click', ()=>{ applySelection(); closeConfirmModal(); });

    $('#submitBtn').addEventListener('click', ()=>{ alert('Submit clicked. (Prototype)'); });

    // Init
    calcExact();
    updateBar();
  </script>
</body>
</html>
