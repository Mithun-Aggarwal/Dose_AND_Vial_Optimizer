<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HCP Infusion Planner — GSK Theme (Final v3)</title>
<style>
  :root{
    --brand:#FF6200; --brand-600:#E55A00; --brand-050:#FFF3E9;
    --text:#1B1B1B; --muted:#6A6A6A; --bg:#F7F7F7; --card:#FFFFFF; --field:#F2F2F2; --border:#E6E6E6;
    --green:#1f7a39; --amber:#b55b00; --red:#b00020; --under:#222222;
    --shadow:0 1px 2px rgba(0,0,0,.06); --shadow-hover:0 2px 8px rgba(0,0,0,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:32px auto;padding:0 20px}

  .infobar{background:var(--brand-050);color:#5A3100;border:1px solid #FFDCC4;border-radius:16px;
    padding:12px 14px;display:flex;gap:10px;align-items:flex-start;margin:0 0 16px}
  .title{font-size:1.5rem;font-weight:800;margin:0 0 14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:20px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px 28px}
  @media (max-width:860px){.grid{grid-template-columns:1fr}}
  .section-h{font-weight:800;font-size:1.15rem;margin:4px 0 4px}
  .section-sub{color:var(--muted);margin:0 0 8px}

  .field{display:flex;flex-direction:column;gap:8px}
  .label{font-weight:700}
  .muted{color:var(--muted)}
  .ro{opacity:.85}
  .input-wrap{position:relative}
  .unit{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#555;font-weight:700}

  input[type="date"],input[type="number"],select{
    width:100%;background:#FFF;border:1px solid var(--border);border-radius:14px;padding:14px 12px;font-size:1rem;
    outline:none;transition:border-color .12s, box-shadow .12s
  }
  input[type="date"]:hover,input[type="number"]:hover,select:hover{border-color:#D6D6D6}
  input[type="date"]:focus,input[type="number"]:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(255,98,0,.35)}
  input[disabled],.ro{background:var(--field)}
  .divider{height:1px;background:var(--border);margin:18px 0}
  .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px 14px;cursor:pointer;transition:box-shadow .12s,background .12s,border-color .12s}
  .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff;font-weight:700}
  .btn.brand:hover{background:var(--brand-600);border-color:var(--brand-600);box-shadow:var(--shadow-hover)}
  .btn.secondary{background:#fff;border-color:var(--brand);color:var(--brand);font-weight:700}
  .btn.ghost{background:#fff;border-color:var(--border);color:#444}
  .btn.block{display:block;width:100%}
  .icon-btn{display:inline-flex;align-items:center;gap:10px;height:44px;border-radius:10px;border:1px solid var(--border);background:#fff;padding:0 12px}
  .inline-summary{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px 16px;box-shadow:var(--shadow)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .center{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap}
  .pill{display:inline-block;background:#fff;border:1px solid var(--brand);color:var(--brand);font-weight:700;border-radius:999px;padding:8px 12px;cursor:pointer}
  .pill-green{background:#e8f5ec;border-color:var(--green);color:var(--green)}
  .pill-amber{background:#fff3e0;border-color:var(--amber);color:var(--amber)}
  .pill-red{background:#ffebee;border-color:var(--red);color:var(--red)}
  .text-positive{color:var(--green);font-weight:700}
  .text-negative{color:var(--red);font-weight:700}
  .choice-banner{background:var(--brand-050);color:#5A3100;font-weight:800;text-transform:uppercase;padding:12px 16px;border-radius:12px;text-align:center;margin-bottom:18px;letter-spacing:.5px}
  .choice-section{margin-bottom:18px}
  .choice-section h3{margin:0 0 8px;font-size:1.05rem;font-weight:800}
  .choice-section p{margin:4px 0;font-size:.95rem;color:#333}
  .choice-section p .mono{font-size:1rem}
  .choice-close-wrap{display:flex;justify-content:center;margin-top:6px}
  .centered-action{display:flex;justify-content:center;margin:0 auto}

  /* Meter */
  .dosebar-wrap{margin-top:12px}
  .dosebar-label{font-size:.95rem;color:#333;margin-bottom:8px;font-weight:700}
  .bar{height:12px;border-radius:999px;position:relative;background:#eee;overflow:hidden}
  .bar-fill{position:absolute;left:0;top:0;bottom:0;width:0;background:var(--under);transition:width .2s ease, background-color .2s ease}
  .marker{position:absolute;top:-5px;bottom:-5px;width:2px;background:#111;opacity:.9}
  .marker-label{position:absolute;top:-22px;transform:translateX(-50%);font-size:.8rem;color:#111;font-weight:800;white-space:nowrap}
  .dosebar-text{font-size:.95rem;margin-top:10px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;color:#222}
  .dosebar-stats{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-weight:600}
  .status-key{display:inline-flex;align-items:center;gap:6px;font-size:.85rem;color:#444;font-weight:600}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .dot-green{background:var(--green)} .dot-amber{background:var(--amber)} .dot-red{background:var(--red)} .dot-under{background:var(--under)}

  .actions-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:860px){.actions-grid{grid-template-columns:1fr}}
  .cardlet{border:1px solid var(--border);background:#fff;border-radius:14px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;box-shadow:var(--shadow)}

  .calc-hint{
    font-size:.95rem;margin-top:12px;padding:10px 14px;border-radius:12px;
    display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    background:var(--brand-050);color:#5A3100;border:1px solid #FFDCC4;font-weight:600;
  }
  .calc-hint-content{
    display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex:1 1 240px;
  }
  .calc-hint-text{flex:1 1 auto;min-width:160px;}
  .calc-hint-label{font-weight:800}
  .calc-link{
    color:var(--brand);font-weight:600;text-decoration:underline;
  }
  .calc-link:focus,.calc-link:hover{
    color:var(--brand-600);
  }

  /* Modal */
  .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;padding:20px;z-index:1000}
  .modal{width:min(880px,100%);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
  .modal-hd{display:flex;justify-content:space-between;align-items:flex-start;padding:14px 16px;border-bottom:1px solid var(--border)}
  .modal-bd{padding:14px 16px;max-height:70vh;overflow:auto}
  .modal-ft{display:flex;flex-direction:column;gap:12px;padding:12px 16px;border-top:1px solid var(--border)}
  .option-row{cursor:pointer;transition:background-color .12s ease}
  .option-row:hover{background:#f4f4f4}
  .option-row.selected{background:var(--brand-050)}
  [hidden]{display:none !important}
</style>
</head>
<body>
<main class="wrap">
  <div class="infobar" role="status" aria-live="polite">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <circle cx="12" cy="12" r="10" stroke="#FF6200" stroke-width="2"/>
      <path d="M12 7.5v.8M12 10.5v6" stroke="#FF6200" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <div>Please review these details. If not correct, please call the MyeCare Program team on <strong>1800 140 272</strong>.</div>
  </div>

  <div class="title">Please answer the following question:</div>

  <div class="card">
    <div class="section-h">Scheduling</div>
    <div class="grid">
      <div class="field">
        <div class="label">What date did the previous infusion happen? <span class="muted">*</span></div>
        <input id="prevDate" type="date" class="ro" value="2025-11-15" disabled aria-disabled="true"/>
      </div>
      <div class="field">
        <div class="label">What date is the next infusion? <span class="muted">*</span></div>
        <input id="nextDate" type="date" class="ro" value="2026-08-01" disabled aria-disabled="true"/>
      </div>
    </div>

    <div class="divider"></div>

    <div class="grid">
      <div class="field">
        <div class="label">Confirm patient’s weight (kg) <span class="muted">*</span></div>
        <div class="input-wrap">
          <input id="weight" type="number" min="0" step="0.1" placeholder="e.g., 91.3" aria-label="Patient weight in kilograms"/>
          <span class="unit">kg</span>
        </div>
      </div>
      <div class="field">
        <div class="label">Confirm patient’s treatment dose <span class="muted">*</span></div>
        <select id="dose" aria-label="Dose regimen in mg per kg">
          <option value="2.5" selected>2.5 mg/kg</option>
          <option value="1.9">1.9 mg/kg</option>
        </select>
      </div>
    </div>

    <div id="calcHint" class="calc-hint" hidden></div>

    <div class="divider"></div>

    <div class="grid">
      <div class="field">
        <div class="label">Confirm number of 70 mg vials</div>
        <input id="v70" type="number" min="0" step="1" value="0"/>
      </div>
      <div class="field">
        <div class="label">Confirm number of 100 mg vials</div>
        <input id="v100" type="number" min="0" step="1" value="0"/>
      </div>
    </div>

    <div id="suggestionsRow" class="center" hidden style="margin-top:10px"></div>

    <div id="doseBarWrap" class="dosebar-wrap" hidden>
      <div class="dosebar-label">Dose &amp; order meter (exp)</div>
      <div class="bar" id="doseBar">
        <div id="doseBarFill" class="bar-fill"></div>
        <div id="doseBarMarker" class="marker" style="left:0%"></div>
        <div id="doseBarMarkerLabel" class="marker-label">Exact dose</div>
      </div>
      <div id="doseBarText" class="dosebar-text">
        <span id="doseBarStats" class="dosebar-stats"></span>
        <span id="doseBarKey" class="status-key" hidden></span>
      </div>
    </div>

    <div class="divider"></div>

    <div class="actions-grid">
      <div class="cardlet" aria-labelledby="calcCardTitle">
        <div class="icon" aria-hidden="true">
          <svg width="34" height="34" viewBox="0 0 64 64" fill="none">
            <rect x="6" y="32" width="18" height="18" rx="3" stroke="#333" stroke-width="2"/>
            <rect x="10" y="36" width="10" height="10" rx="2" fill="#333"/>
            <path d="M34 18 l8 8" stroke="#333" stroke-width="2"/>
            <path d="M30 22 l8 8" stroke="#333" stroke-width="2"/>
            <rect x="38" y="10" width="14" height="8" rx="2" fill="#333"/>
            <rect x="40" y="20" width="10" height="18" rx="2" stroke="#333" stroke-width="2"/>
          </svg>
        </div>
        <div>
          <h4 id="calcCardTitle" style="margin:0 0 4px">Dose & vial calculator</h4>
          <div class="muted">Opens as a sandbox (advisory). Does not change the form.</div>
          <div style="margin-top:10px">
            <button class="icon-btn" id="openCalc" title="Open dose & vial optimizer" aria-label="Open calculator">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="3" y="2" width="18" height="20" rx="3" stroke="#333" stroke-width="1.5"/>
                <rect x="7" y="5" width="10" height="4" rx="1.2" fill="#333"/>
                <g stroke="#333" stroke-width="1.4" stroke-linecap="round">
                  <path d="M8.5 12h2.5M8.5 14.5h2.5"/>
                  <path d="M13 12h2.5M13 14.5h2.5"/>
                  <path d="M8.5 17h2.5M13 17h2.5"/>
                </g>
              </svg>
              <span class="label">Open calculator</span>
            </button>
          </div>
        </div>
      </div>
      <div class="cardlet">
        <div class="icon" aria-hidden="true">
          <svg width="34" height="34" viewBox="0 0 64 64" fill="none">
            <path d="M10 52h44" stroke="#333" stroke-width="2"/>
            <rect x="14" y="12" width="36" height="38" rx="3" stroke="#333" stroke-width="2"/>
            <path d="M20 20h24M20 28h24M20 36h18" stroke="#333" stroke-width="2"/>
          </svg>
        </div>
        <div>
          <h4 style="margin:0 0 4px">View TGA official guidance</h4>
          <div class="muted">Always verify with PI before finalising.</div>
          <div style="margin-top:10px">
            <a href="https://www.tga.gov.au/resources/prescription-medicines-under-evaluation/blenrep-glaxosmithkline-australia-pty-ltd" class="btn secondary" target="_blank" rel="noopener" aria-label="Open TGA official guidance">Open guidance</a>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>
    <button id="resetBtn" class="btn ghost block" aria-label="Reset form">Reset</button>
  </div>
</main>

<div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modal-hd">
      <div id="modalTitle" class="label">Dose &amp; Vial Calculator</div>
      <button class="icon-btn" id="closeModal" aria-label="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#333" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-bd">
      <div class="inline-summary" style="margin-bottom:12px">
        <div class="label" style="margin-bottom:6px">Method</div>
        <ul style="margin:0 0 0 18px; padding:0; color:#444">
          <li>Vial strengths: 70 mg and 100 mg.</li>
          <li>Options are computed for the exact required dose.</li>
          <li>Sorted by least <b>waste</b> first; tie-breakers: fewer total vials, then lower total mg.</li>
        </ul>
      </div>
      <div class="grid">
        <div class="field">
          <div class="label">Patient weight (kg)</div>
          <input id="mWeight" type="number" min="0" step="0.1" placeholder="e.g., 91.3"/>
        </div>
        <div class="field">
          <div class="label">Dose regimen (mg/kg)</div>
          <select id="mDose">
            <option value="">-- Select dose regimen --</option>
            <option value="2.5">2.5 mg/kg</option>
            <option value="1.9">1.9 mg/kg</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Search cap (internal)</div>
          <div class="inline-summary"><span id="maxVialText" class="mono">Max vial option: 10</span></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="inline-summary">
        <div id="mCalcLine" class="muted">Set weight and dose to view options.</div>
        <div style="margin-top:6px"><span class="label">Exact required dose:</span> <span id="mExact" class="mono">0.00</span> mg</div>
      </div>

      <div style="margin-top:8px" class="muted">Top 3 least-waste options</div>
      <div style="margin-top:6px;overflow:auto">
        <table id="results" style="border-collapse:collapse;width:100%;min-width:620px">
          <thead>
            <tr>
              <th style="border:1px solid var(--border);padding:8px 10px;text-align:left">Option</th>
              <th style="border:1px solid var(--border);padding:8px 10px;text-align:right">Composition</th>
              <th style="border:1px solid var(--border);padding:8px 10px;text-align:right">Total (mg)</th>
              <th style="border:1px solid var(--border);padding:8px 10px;text-align:right">Waste (mg)</th>
              <th style="border:1px solid var(--border);padding:8px 10px;text-align:right">Waste %</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn brand block" id="apply" title="Apply Vial composition to the form" aria-label="Apply Vial composition to the form">Apply Vial composition to the form</button>
      <div class="muted" style="text-align:center">Use this as a calculator; enter your final decision on the form.</div>
    </div>
  </div>
</div>

<div id="choiceBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="choiceTitle">
  <div class="modal" style="max-width:720px">
    <div class="modal-bd">
      <div class="choice-banner">READ CAREFULLY: YOU ARE ABOUT TO SELECT</div>
      <section class="choice-section" aria-labelledby="choiceTitle">
        <h3 id="choiceTitle">Dose Calculation based on the Weight &amp; Dose you have selected.</h3>
        <p>Patient weight: <span id="choiceWeight" class="mono">0.00</span> kg</p>
        <p>Selected regimen: <span id="choiceSelectedDose" class="text-positive">—</span></p>
        <p>Calculation: <span id="choiceCalcResult" class="mono">0.00 mg</span></p>
      </section>
      <section class="choice-section">
        <h3>Suggested Vial Composition</h3>
        <p id="choiceVialSummary" class="mono">—</p>
        <p id="choiceVialDetail" class="mono" style="color:#444">—</p>
        <p id="choiceWasteNotice" class="muted" style="font-size:.85rem">—</p>
      </section>
    </div>
    <div class="modal-ft">
      <a href="https://www.tga.gov.au/resources/prescription-medicines-under-evaluation/blenrep-glaxosmithkline-australia-pty-ltd"
         class="btn brand block" target="_blank" rel="noopener" aria-label="Open TGA guidance">Open TGA guidance</a>
      <button class="btn brand block" id="choiceApply" title="Apply Vial composition to the form" aria-label="Apply Vial composition to the form">Apply Vial composition to the form</button>
      <div class="muted" style="text-align:center">You remain responsible for clinical decisions. Verify with PI.</div>
      <div class="choice-close-wrap">
        <button class="icon-btn" id="choiceClose" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#333" stroke-width="2" stroke-linecap="round"/></svg>
          <span>Close</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
const el  = id => document.getElementById(id);
const fmt2 = n => Number(n).toFixed(2);
const fmt0 = n => Math.round(Number(n)).toLocaleString();
const EPS = 1e-9;

function exactDose(weight, dose){ return (weight>0 && dose>0) ? (weight*dose) : 0; }
function enumerateValidPlans(E, cap=10){
  const out=[];
  for(let a=0;a<=cap;a++){
    for(let b=0;b<=cap;b++){
      const T=a*70+b*100; if(T<=0) continue; if(T+EPS<E) continue;
      const W=T-E, Wpct=T>0?(W/T*100):0; out.push({a,b,total:T,waste:W,wastePct:Wpct});
    }
  }
  out.sort((x,y)=>{
    if (Math.abs(x.waste - y.waste) > 1e-9) return x.waste - y.waste;
    const vx=(x.a+x.b), vy=(y.a+y.b); if(vx!==vy) return vx - vy;
    return x.total - y.total;
  });
  return out;
}
function singlesThatMeet(E, cap=10){ return { n70:Math.min(Math.ceil(E/70),cap), n100:Math.min(Math.ceil(E/100),cap) }; }
function compText(a,b){
  const p=[];
  if(a>0) p.push(`70mg × ${a}`);
  if(b>0) p.push(`100mg × ${b}`);
  return p.length ? p.join(' + ') : '—';
}

/* ===== DOM refs & state ===== */
const inputs = {
  weight: el('weight'), dose: el('dose'), v70: el('v70'), v100: el('v100'),
  calcHint: el('calcHint'),
  doseBarWrap: el('doseBarWrap'), doseBarFill: el('doseBarFill'),
  doseBarMarker: el('doseBarMarker'), doseBarMarkerLabel: el('doseBarMarkerLabel'), doseBarText: el('doseBarText'),
  doseBarStats: el('doseBarStats'), doseBarKey: el('doseBarKey'),
  suggestionsRow: el('suggestionsRow'),
  openCalc: el('openCalc'), resetBtn: el('resetBtn')
};
const modal = {
  backdrop: el('backdrop'), close: el('closeModal'),
  mWeight: el('mWeight'), mDose: el('mDose'),
  mCalcLine: el('mCalcLine'), mExact: el('mExact'),
  results: document.querySelector('#results tbody'), maxVialText: el('maxVialText'), apply: el('apply')
};
modal.currentPlan = null;
modal.apply.disabled = true;
const choice = {
  backdrop: el('choiceBackdrop'),
  title: el('choiceTitle'),
  weight: el('choiceWeight'), selectedDose: el('choiceSelectedDose'),
  calcResult: el('choiceCalcResult'), vialSummary: el('choiceVialSummary'),
  vialDetail: el('choiceVialDetail'), wasteNotice: el('choiceWasteNotice'),
  apply: el('choiceApply'), close: el('choiceClose')
};
choice.currentPlan = null;
choice.apply.disabled = true;
const state = { weight:0, dose:0, E:0, cap:10 };
const DEFAULT_CHOICE_TITLE = 'Dose Calculation based on the Weight & Dose you have selected.';

function applyPlanToForm(plan){
  if(!plan) return;
  inputs.v70.value = plan.a;
  inputs.v100.value = plan.b;
  updateDoseBar();
}

/* ===== Init/Reset ===== */
function resetForm(){
  inputs.weight.value=''; inputs.dose.value='2.5'; inputs.v70.value=0; inputs.v100.value=0;
  state.weight=0; state.dose=0; state.E=0;
  inputs.calcHint.hidden = true;
  inputs.doseBarWrap.hidden=true; inputs.suggestionsRow.hidden=true; inputs.suggestionsRow.innerHTML='';
  modal.mWeight.value=''; modal.mDose.value=''; modal.maxVialText.textContent=`Max vial option: ${state.cap}`;
  modal.currentPlan = null;
  modal.apply.disabled = true;
  choice.currentPlan = null;
  choice.apply.disabled = true;
  refreshModal();
}
inputs.resetBtn.addEventListener('click', resetForm);

/* ===== Calculator modal ===== */
inputs.openCalc.addEventListener('click', ()=>{ refreshModal(); modal.backdrop.style.display='flex'; });
modal.close.addEventListener('click', ()=>{ modal.backdrop.style.display='none'; modal.currentPlan=null; modal.apply.disabled=true; });
modal.backdrop.addEventListener('click',(e)=>{
  if(e.target===modal.backdrop){
    modal.backdrop.style.display='none';
    modal.currentPlan=null;
    modal.apply.disabled=true;
  }
});
['input','change'].forEach(evt=>{
  modal.mWeight.addEventListener(evt, refreshModal);
  modal.mDose.addEventListener(evt, refreshModal);
});
function refreshModal(){
  const w=Number(modal.mWeight.value||0), d=Number(modal.mDose.value||0); const ok=(w>0 && d>0); const E= ok? exactDose(w,d):0;
  modal.mCalcLine.textContent = ok? `Calculation: ${fmt2(d)} mg/kg × ${fmt2(w)} kg = ${fmt2(E)} mg` : 'Set weight and dose to view options.';
  modal.mExact.textContent = fmt2(E);
  modal.results.innerHTML='';
  modal.currentPlan = null;
  modal.apply.disabled = true;
  if(ok){
    const options=enumerateValidPlans(E,state.cap).slice(0,3);
    options.forEach((o,idx)=>{
      const label = idx===0 ? `Option ${idx+1} (Least waste)` : `Option ${idx+1}`;
      const plan = {
        a: o.a,
        b: o.b,
        total: o.total,
        waste: o.waste,
        wastePct: o.wastePct,
        weight: w,
        dose: d,
        exact: E,
        summaryPrefix: label
      };
      const tr=document.createElement('tr');
      tr.className='option-row';
      tr.setAttribute('tabindex','0');
      tr.setAttribute('role','button');
      tr.setAttribute('aria-selected','false');
      tr.setAttribute('aria-label', `${label}: ${compText(o.a,o.b)}. Total ${fmt0(o.total)} mg. Waste ${fmt2(o.waste)} mg (${o.wastePct.toFixed(2)}%).`);
      tr.innerHTML=`
        <td style="border:1px solid var(--border);padding:8px 10px">${label}</td>
        <td style="border:1px solid var(--border);padding:8px 10px;text-align:right">${compText(o.a,o.b)}</td>
        <td style="border:1px solid var(--border);padding:8px 10px;text-align:right">${fmt0(o.total)}</td>
        <td style="border:1px solid var(--border);padding:8px 10px;text-align:right">${fmt2(o.waste)}</td>
        <td style="border:1px solid var(--border);padding:8px 10px;text-align:right">${o.wastePct.toFixed(2)}%</td>`;
      const selectPlan = ()=>{
        Array.from(modal.results.children).forEach(row=>{
          row.classList.remove('selected');
          row.setAttribute('aria-selected','false');
        });
        tr.classList.add('selected');
        tr.setAttribute('aria-selected','true');
        modal.currentPlan = plan;
        modal.apply.disabled = false;
      };
      tr.addEventListener('click', selectPlan);
      tr.addEventListener('keydown',(evt)=>{
        if(evt.key==='Enter' || evt.key===' '){
          evt.preventDefault();
          selectPlan();
        }
      });
      modal.results.appendChild(tr);
      if(idx===0) selectPlan();
    });
    if(!options.length){
      modal.currentPlan = null;
      modal.apply.disabled = true;
    }
  }
}

/* ===== Main refresh ===== */
['input','change'].forEach(evt=>{
  inputs.weight.addEventListener(evt, refreshMain);
  inputs.dose.addEventListener(evt, refreshMain);
  inputs.v70.addEventListener(evt, updateDoseBar);
  inputs.v100.addEventListener(evt, updateDoseBar);
});
function refreshMain(){
  const w=Number(inputs.weight.value||0), d=Number(inputs.dose.value||0); const ok=(w>0 && d>0);
  state.weight=w; state.dose=d; state.E= ok? exactDose(w,d):0;

  // Tiny inline TGA line
  if(ok){
    inputs.calcHint.hidden=false;
    // UPDATED to be more formal and compliant
    inputs.calcHint.innerHTML = `
      <div class="calc-hint-content">
        <span class="calc-hint-label">TGA recommended dose:</span>
        <span class="calc-hint-text">${fmt2(state.weight)} kg × ${fmt2(state.dose)} mg/kg = <b>${fmt2(state.E)} mg</b></span>
      </div>
      <a class="calc-link" href="https://www.tga.gov.au/resources/prescription-medicines-under-evaluation/blenrep-glaxosmithkline-australia-pty-ltd" target="_blank" rel="noopener">View TGA guidance</a>
    `.trim();
  } else {
    inputs.calcHint.hidden=true;
  }

  inputs.doseBarWrap.hidden = !ok;

  // Suggestions
  if(ok){
    const options = enumerateValidPlans(state.E, state.cap);
    const best = options.length ? options[0] : null;
    const row=inputs.suggestionsRow; row.innerHTML='';
    if(best){
      const btn=document.createElement('button'); btn.className='pill';
      if(best.wastePct<=25) btn.classList.add('pill-green'); else if(best.wastePct<=50) btn.classList.add('pill-amber'); else btn.classList.add('pill-red');
      const overRatio = state.E>0 ? ((best.total - state.E)/state.E) : 0;
      const overPct = (overRatio*100).toFixed(2);
      btn.textContent = `Suggestion : ${compText(best.a,best.b)} = ${fmt0(best.total)} mg • ${overPct}% above exact`;
      btn.setAttribute('aria-label','Open suggested vial composition details');
      btn.addEventListener('click',()=> openChoicePopup(best, { summaryPrefix:'Suggestion', heading:'Suggested Vial Composition', weight:state.weight, dose:state.dose, exact:state.E }));
      row.appendChild(btn);
      row.hidden=false;
    } else {
      row.hidden=true;
    }
  } else {
    inputs.suggestionsRow.hidden=true; inputs.suggestionsRow.innerHTML='';
  }

  updateDoseBar();
}

/* ===== Meter ===== */
function setDoseBarKey(dotClass,label){
  if(dotClass && label){
    inputs.doseBarKey.innerHTML = `<span class="dot ${dotClass}"></span><span>${label}</span>`;
    inputs.doseBarKey.hidden = false;
  } else {
    inputs.doseBarKey.innerHTML = '';
    inputs.doseBarKey.hidden = true;
  }
}
function updateDoseBar(){
  const E=state.E; if(!(E>0)){ inputs.doseBarWrap.hidden=true; inputs.doseBarStats.textContent=''; setDoseBarKey(); return; }
  const a=Number(inputs.v70.value||0), b=Number(inputs.v100.value||0); const T=a*70+b*100;
  let scaleMax=Math.max(E,T,1)*1.2;
  const fillPct=Math.min(100,Math.max(0,(T/scaleMax)*100));
  const markerPct=Math.min(100,Math.max(0,(E/scaleMax)*100));
  inputs.doseBarFill.style.width=`${fillPct.toFixed(1)}%`;
  inputs.doseBarMarker.style.left=`${markerPct.toFixed(1)}%`;
  inputs.doseBarMarkerLabel.style.left=`${markerPct.toFixed(1)}%`;

  if(T + EPS < E){
    inputs.doseBarFill.style.background=getComputedStyle(document.documentElement).getPropertyValue('--under').trim()||'#222';
    inputs.doseBarStats.textContent=`Under by ${fmt2(E-T)} mg`;
    setDoseBarKey('dot-under','Under target');
  }else{
    const W=T-E; const Wpct=T>0?(W/T*100):0;
    let color=getComputedStyle(document.documentElement).getPropertyValue('--green').trim()||'#1f7a39';
    let dotClass='dot-green';
    let label='Low waste (≤25%)';
    if(Wpct>50) color=getComputedStyle(document.documentElement).getPropertyValue('--red').trim()||'#b00020';
    if(Wpct>50){ dotClass='dot-red'; label='High (>50%)'; }
    else if(Wpct>25){ color=getComputedStyle(document.documentElement).getPropertyValue('--amber').trim()||'#b55b00'; dotClass='dot-amber'; label='Moderate (25–50%)'; }
    inputs.doseBarFill.style.background=color;
    inputs.doseBarStats.textContent=`Total ${fmt0(T)} mg • Waste ${fmt2(W)} mg (${Wpct.toFixed(2)}%)`;
    setDoseBarKey(dotClass,label);
  }
  inputs.doseBarWrap.hidden=false;
}

/* ===== Confirmation popup ===== */
function openChoicePopup(plan, meta={}){
  if(!plan) return;
  const weight = meta.weight ?? state.weight;
  const dose = meta.dose ?? state.dose;
  const doseDisplay = dose>0 ? fmt2(dose) : '0.00';
  const exact = meta.exact ?? ((weight>0 && dose>0) ? exactDose(weight, dose) : 0);
  const total = plan.total ?? (plan.a*70 + plan.b*100);
  const waste = (typeof plan.waste === 'number') ? plan.waste : (total - exact);
  const wastePct = (typeof plan.wastePct === 'number') ? plan.wastePct : (total>0 ? ((waste/total)*100) : 0);

  choice.title.textContent = meta.heading || DEFAULT_CHOICE_TITLE;
  choice.weight.textContent = fmt2(weight);
  choice.selectedDose.textContent = dose>0 ? `${doseDisplay} mg/kg regimen` : 'No regimen selected';
  choice.calcResult.textContent = `${doseDisplay} mg/kg × ${fmt2(weight)} kg = ${fmt2(exact)} mg`;

  const compositionText = compText(plan.a, plan.b);
  const summaryPrefix = meta.summaryPrefix || 'Suggestion';
  choice.vialSummary.textContent = `${summaryPrefix} : ${compositionText} = ${fmt0(total)} mg`;
  choice.vialDetail.textContent = `Dose = ${fmt2(exact)} mg • Waste ${fmt2(waste)} mg (${wastePct.toFixed(2)}%)`;
  choice.wasteNotice.textContent = meta.wasteNotice || 'Leftover product cannot be re-used per TGA guidelines.';

  choice.currentPlan = { a: plan.a, b: plan.b };
  choice.apply.disabled = false;
  choice.backdrop.style.display='flex';
}
function closeChoiceModal(){
  choice.backdrop.style.display='none';
  choice.currentPlan=null;
  choice.apply.disabled=true;
  choice.title.textContent = DEFAULT_CHOICE_TITLE;
}
choice.backdrop.addEventListener('click',(e)=>{
  if(e.target===choice.backdrop){
    closeChoiceModal();
  }
});
choice.close.addEventListener('click',()=>{
  closeChoiceModal();
});

modal.apply.addEventListener('click', ()=>{
  if(!modal.currentPlan) return;
  modal.backdrop.style.display='none';
  openChoicePopup(modal.currentPlan, {
    summaryPrefix: modal.currentPlan.summaryPrefix || 'Selected option',
    heading: 'Confirm this vial option',
    weight: modal.currentPlan.weight,
    dose: modal.currentPlan.dose,
    exact: modal.currentPlan.exact,
    wasteNotice: 'Review before applying to the form. Leftover product cannot be re-used per TGA guidelines.'
  });
});

choice.apply.addEventListener('click', ()=>{
  if(!choice.currentPlan) return;
  applyPlanToForm(choice.currentPlan);
  closeChoiceModal();
});

/* Boot */
document.addEventListener('DOMContentLoaded', resetForm);
</script>
</body>
</html>