<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HCP Infusion Planner — Premium Mock with Optimizer</title>
  <style>
    :root{
      --brand:#8F0E1A;          /* deep red from screenshot */
      --brand-ink:#6f0c15;
      --text:#2a2a2a;
      --muted:#6f6f6f;
      --bg:#fafafa;
      --card:#ffffff;
      --field:#f2f2f2;          /* light grey input */
      --border:#e6e6e6;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:12px;
      --accent:#f26b1a;         /* subtle action color */
      --ok:#1a7f37;
      --warn:#b3261e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);line-height:1.45}

    .wrap{max-width:980px;margin:48px auto;padding:0 20px}

    .title{font-weight:800;color:var(--brand);font-size:1.35rem;margin-bottom:10px}
    .subtle{color:var(--muted);margin:6px 0 16px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin:18px 0}

    .divider{height:1px;background:var(--border);margin:22px 0}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:26px 32px;align-items:start}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}

    .field{display:flex;flex-direction:column;gap:8px}
    .label{font-weight:700}
    .input,select{width:100%;background:var(--field);border:1px solid var(--border);border-radius:var(--radius);padding:16px 14px;font-size:1rem;outline:none}
    .input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(143,14,26,.12)}

    .hint{font-size:.9rem;color:var(--muted)}
    .hint .pill{display:inline-block;margin-left:6px;margin-right:2px;padding:2px 8px;border-radius:999px;border:1px solid var(--brand);color:var(--brand);font-weight:700;font-size:.8rem}

    .inline-summary{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:none}
    .inline-summary strong{color:var(--brand)}

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .btn{background:var(--brand);border:none;color:#fff;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
    .btn:disabled{opacity:.55;cursor:default}

    /* Delta strip */
    .delta{grid-column:1 / -1; display:none; border:1px solid var(--border); border-radius:12px; padding:12px 14px; background:#fff}
    .delta.ok{border-color:#d6ead9}
    .delta.ok strong{color:var(--ok)}
    .delta.under{border-color:#f2d7d7}
    .delta.under strong{color:var(--warn)}
    .bar{height:8px; background:#eee; border-radius:999px; overflow:hidden; margin-top:8px}
    .bar > span{display:block; height:100%; background:linear-gradient(90deg, rgba(26,127,55,.9), rgba(26,127,55,.6)); width:0}
    .bar.under > span{background:linear-gradient(90deg, rgba(179,38,30,.9), rgba(179,38,30,.6))}
    .delta .note{display:block; margin-top:6px; font-size:.85rem; color:var(--muted)}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:24px;z-index:1000}
    .modal.active{display:flex}
    .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
    .sheet{position:relative;background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);max-width:960px;width:100%;max-height:88vh;overflow:auto}
    .sheet .head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);}
    .sheet .title{margin:0;color:var(--brand);font-size:1.2rem}
    .x{background:none;border:none;font-size:1.6rem;color:var(--brand-ink);cursor:pointer}
    .sheet .body{padding:18px}
    .sheet .foot{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);padding:12px 18px;display:flex;gap:10px;justify-content:flex-end}

    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border)}
    th{background:#f7f7f7;text-align:left;color:#555}
    td{text-align:right}
    th:first-child,td:first-child{text-align:left}

    .badge{display:inline-block;margin-left:8px;padding:2px 6px;border-radius:999px;border:1px solid var(--brand);color:var(--brand);font-weight:700;font-size:.75rem}

    .summary-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px}

  </style>
</head>
<body>
  <main class="wrap">
    <div class="title">Please answer the following question:</div>
    <div class="card">
      <div style="display:flex;gap:28px;flex-wrap:wrap">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Is the patient continuing on treatment?</div>
          <label style="display:inline-flex;align-items:center;gap:8px;margin-right:16px"><input type="radio" name="cont" checked> Yes</label>
          <label style="display:inline-flex;align-items:center;gap:8px"><input type="radio" name="cont"> No</label>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Has the patient’s treatment been delayed?</div>
          <label style="display:inline-flex;align-items:center;gap:8px;margin-right:16px"><input type="radio" name="delay"> Yes</label>
          <label style="display:inline-flex;align-items:center;gap:8px"><input type="radio" name="delay" checked> No</label>
        </div>
      </div>
      <div class="divider"></div>

      <!-- Infusion details grid -->
      <div class="grid">
        <div class="field">
          <label class="label" for="prev">What date did the previous infusion happen?*</label>
          <input class="input" id="prev" type="text" placeholder="Select previous date" />
        </div>
        <div class="field">
          <label class="label" for="next">What date is the next infusion?*</label>
          <input class="input" id="next" type="text" placeholder="Select next date" />
        </div>

        <div class="field">
          <label class="label" for="weight">Confirm patient’s weight*</label>
          <input class="input" id="weight" type="number" min="0" step="0.1" placeholder="e.g., 86" />
          <div id="inlineSummary" class="inline-summary" aria-live="polite"></div>
        </div>
        <div class="field">
          <label class="label" for="dose">Confirm patient’s treatment dose*</label>
          <select id="dose" class="input">
            <option value="2.5">2.5 mg/kg (Start)</option>
            <option value="1.9">1.9 mg/kg (Reduced)</option>
          </select>
          <div class="actions">
            <button class="btn" id="openOptimizer" disabled>Open Full Dose & Vial Optimizer</button>
            <span class="hint">Two vial strengths are available: 70 mg & 100 mg.</span>
          </div>
        </div>

        <div class="field">
          <label class="label" for="vials70">Confirm number of 70 mg vials</label>
          <input id="vials70" class="input" type="number" min="0" step="1" placeholder="0" />
          <div id="hint70" class="hint"></div>
        </div>
        <div class="field">
          <label class="label" for="vials100">Confirm number of 100 mg vials</label>
          <input id="vials100" class="input" type="number" min="0" step="1" placeholder="0" />
          <div id="hint100" class="hint"></div>
        </div>

        <!-- Advisory delta strip spanning both columns -->
        <div class="delta" id="doseDelta" aria-live="polite">
          <!-- filled dynamically -->
          <div class="bar" id="doseBar"><span></span></div>
          <span class="note">Guidance only. Please verify against PI and local policy.</span>
        </div>

        <div class="field">
          <label class="label" for="freq">Confirm infusion frequency*</label>
          <select id="freq" class="input">
            <option>3 weeks</option>
            <option>2 weeks</option>
            <option>4 weeks</option>
          </select>
        </div>
        <div class="field"></div>
      </div>

      <div class="divider"></div>
      <div class="summary-card" id="bottomSummary" style="display:none"></div>
    </div>
  </main>

  <!-- Optimizer Modal -->
  <section class="modal" id="optimizerModal" aria-hidden="true" role="dialog" aria-label="Dose & Vial Optimizer">
    <div class="backdrop" data-close></div>
    <div class="sheet" role="document">
      <div class="head">
        <h3 class="title">Dose & Vial Optimizer — 70 mg / 100 mg</h3>
        <button class="x" data-close aria-label="Close">×</button>
      </div>
      <div class="body">
        <div class="grid">
          <div class="field">
            <label class="label">Patient weight (kg)</label>
            <input id="mWeight" type="number" min="0" step="0.1" class="input" />
          </div>
          <div class="field">
            <label class="label">Dose regimen (mg/kg)</label>
            <select id="mDose" class="input">
              <option value="2.5">2.5 mg/kg (Start)</option>
              <option value="1.9">1.9 mg/kg (Reduced)</option>
            </select>
          </div>
          <div class="field">
            <label class="label">Max total vials</label>
            <input id="maxVials" type="number" min="1" step="1" value="10" class="input" />
            <span class="hint">Two strengths only: 70 mg and 100 mg. No underdosing.</span>
          </div>
        </div>

        <div class="divider"></div>
        <div id="mSummary" class="summary-card">Enter weight to calculate.</div>

        <div class="divider"></div>
        <div class="table-wrap">
          <table id="resultTable" style="display:none">
            <thead>
              <tr>
                <th>Option</th>
                <th>70 mg vials</th>
                <th>100 mg vials</th>
                <th>Total (mg)</th>
                <th>Waste (mg)</th>
                <th>Waste (%)</th>
                <th>Total vials</th>
              </tr>
            </thead>
            <tbody id="resultBody"></tbody>
          </table>
        </div>
      </div>
      <div class="foot">
        <button class="btn ghost" data-close>Cancel</button>
        <button class="btn" id="applyToForm" disabled>Apply to form</button>
      </div>
    </div>
  </section>

  <script>
    // --- Helpers & State ---
    const $ = (id)=>document.getElementById(id);
    const V70 = 70, V100 = 100;

    function fmt(n,d=0){return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});}
    function exactDose(w,mg){if(!(w>0)||!(mg>0))return NaN;return Math.round(w*mg*100)/100;} // 2dp
    function roundedRequired(exact){return Math.ceil(exact);} // for vial calc

    function enumerate(required,maxVials=10){
      const out=[]; const maxA=Math.min(maxVials,Math.ceil(required/V70)+6); const maxB=Math.min(maxVials,Math.ceil(required/V100)+6);
      for(let a=0;a<=maxA;a++){
        for(let b=0;b<=maxB;b++){
          const v=a+b; if(v===0||v>maxVials) continue;
          const total=a*V70+b*V100; if(total<required) continue;
          const waste=total-required; const wastePct= total? waste/total:0;
          out.push({a,b,total,waste,wastePct,totalVials:v});
        }
      }
      out.sort((p,q)=> p.waste!==q.waste? p.waste-q.waste : (p.totalVials-q.totalVials)|| (p.total-q.total));
      return out;
    }

    // Cache required rounded on the page for reuse in delta
    let lastRequired = null; let lastExact = null; let lastBest = null; let lastOnly70 = null; let lastOnly100 = null;

    // --- Inline Summary on Main Form + hints ---
    function updateInline(){
      const w=parseFloat($('weight').value); const d=parseFloat($('dose').value);
      const box=$('inlineSummary'); const btn=$('openOptimizer'); const btm=$('bottomSummary');
      if(!(w>0)){ box.style.display='none'; btn.disabled=true; btm.style.display='none'; $('hint70').textContent=''; $('hint100').textContent=''; lastRequired=null; updateDelta(); return; }
      const exact=exactDose(w,d); const req=roundedRequired(exact); const opts=enumerate(req,10);
      if(!opts.length){ box.style.display='none'; btn.disabled=true; btm.style.display='none'; lastRequired=null; updateDelta(); return; }
      const best=opts[0];
      const only70 = opts.find(o=>o.b===0) || {a:0,total:req,waste:0};
      const only100 = opts.find(o=>o.a===0) || {b:0,total:req,waste:0};

      lastRequired=req; lastExact=exact; lastBest=best; lastOnly70=only70; lastOnly100=only100;

      box.innerHTML = `<strong>Exact required dose:</strong> ${fmt(exact,2)} mg<br><strong>Suggested (mixed):</strong> ${best.a}×70 mg + ${best.b}×100 mg <span class="hint">(Total ${fmt(best.total)} mg · Waste ${fmt(best.waste)} mg / ${(best.wastePct*100).toFixed(2)}%)</span>`;
      box.style.display='block';
      btn.disabled=false;

      // Hints under vial fields
      $('hint70').innerHTML = `Suggested <em>70‑only</em>: <span class="pill">×${only70.a||0}</span> · Mixed best uses <span class="pill">×${best.a}</span>`;
      $('hint100').innerHTML = `Suggested <em>100‑only</em>: <span class="pill">×${only100.b||0}</span> · Mixed best uses <span class="pill">×${best.b}</span>`;

      // Update bottom summary live
      btm.innerHTML = `<strong>Summary</strong><br>Exact: ${fmt(exact,2)} mg · Rounded for vials: ${fmt(req)} mg<br>Recommendation: ${best.a}×70 mg + ${best.b}×100 mg (Total ${fmt(best.total)} mg, Waste ${fmt(best.waste)} mg / ${(best.wastePct*100).toFixed(2)}%)`;
      btm.style.display='block';

      updateDelta();
    }

    $('weight').addEventListener('input',updateInline);
    $('dose').addEventListener('change',updateInline);

    // --- Advisory Delta (over/under/waste) ---
    function updateDelta(){
      const strip=$('doseDelta'); const bar=$('doseBar'); const barFill=bar.querySelector('span');
      const a=parseInt(($('vials70').value||'0'),10); const b=parseInt(($('vials100').value||'0'),10);
      if(!lastRequired){ strip.style.display='none'; return; }
      const total = (a*V70) + (b*V100);
      const under = total < lastRequired;
      const diff = Math.abs(total - lastRequired);
      strip.classList.remove('ok','under');
      if(under){
        strip.classList.add('under');
        strip.innerHTML = `<strong>Under by: ${fmt(diff)} mg</strong> <span class="hint">(Total ordered ${fmt(total)} mg; needs ≥ ${fmt(lastRequired)} mg)</span>` + strip.innerHTML;
        bar.classList.add('under');
      }else{
        const waste = total - lastRequired; const pct = total? (waste/total)*100 : 0;
        strip.classList.add('ok');
        strip.innerHTML = `<strong>Total ordered: ${fmt(total)} mg</strong> · Waste: ${fmt(waste)} mg (${fmt(pct,2)}%)<div class="bar" id="doseBar"><span></span></div><span class="note">Guidance only. Please verify against PI and local policy.</span>`;
      }
      // Update bar width relative to requirement (cap 160%)
      const ratio = Math.min(total / lastRequired, 1.6);
      barFill.style.width = (ratio*100/1.6)+"%";
      strip.style.display='block';
    }

    ['vials70','vials100'].forEach(id=> $(id).addEventListener('input',updateDelta));

    // --- Modal open/close ---
    const modal=$('optimizerModal');
    function openModal(){
      $('mWeight').value = $('weight').value || '';
      $('mDose').value = $('dose').value;
      $('resultTable').style.display='none'; $('resultBody').innerHTML='';
      $('applyToForm').disabled=true;
      $('mSummary').textContent = 'Enter weight to calculate.';
      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }
    $('openOptimizer').addEventListener('click',openModal);
    modal.addEventListener('click',(e)=>{ if(e.target.hasAttribute('data-close')) closeModal(); });

    // --- Modal calc & render ---
    function renderModal(){
      const w=parseFloat($('mWeight').value); const d=parseFloat($('mDose').value); const max=parseInt($('maxVials').value||'10',10);
      if(!(w>0)){ $('mSummary').textContent='Please enter patient weight.'; $('resultTable').style.display='none'; $('applyToForm').disabled=true; return; }
      const exact=exactDose(w,d); const req=roundedRequired(exact);
      const opts=enumerate(req,max);
      $('mSummary').innerHTML = `<strong>${fmt(d,1)} mg/kg × ${fmt(w,1)} kg</strong> → Exact <strong>${fmt(exact,2)} mg</strong> (rounded to <strong>${fmt(req)}</strong> mg for vial calc).`;
      if(!opts.length){ $('resultTable').style.display='none'; $('applyToForm').disabled=true; return; }
      const body=$('resultBody'); body.innerHTML='';
      const best=opts[0];
      opts.slice(0,6).forEach((o,i)=>{
        const tr=document.createElement('tr');
        const optCell=document.createElement('td'); optCell.textContent=`Option ${i+1}`; if(o===best){const b=document.createElement('span'); b.className='badge'; b.textContent='Least waste'; optCell.appendChild(b);} tr.appendChild(optCell);
        ;['a','b'].forEach(k=>{const td=document.createElement('td'); td.textContent=o[k]; tr.appendChild(td);});
        const tdT=document.createElement('td'); tdT.textContent=fmt(o.total); tr.appendChild(tdT);
        const tdW=document.createElement('td'); tdW.textContent=fmt(o.waste); tr.appendChild(tdW);
        const tdWp=document.createElement('td'); tdWp.textContent=(o.wastePct*100).toFixed(2)+'%'; tr.appendChild(tdWp);
        const tdV=document.createElement('td'); tdV.textContent=o.totalVials; tr.appendChild(tdV);
        tr.dataset.combo = JSON.stringify({a:o.a,b:o.b});
        tr.style.cursor='pointer';
        tr.addEventListener('click',()=>{
          [...body.children].forEach(r=>r.style.background=''); tr.style.background='#fff7f7';
          $('applyToForm').dataset.combo = tr.dataset.combo; $('applyToForm').disabled=false;
        });
        body.appendChild(tr);
      });
      $('resultTable').style.display='table';
      $('applyToForm').dataset.combo = JSON.stringify({a:best.a,b:best.b});
      $('applyToForm').disabled=false;
    }

    ['mWeight','mDose','maxVials'].forEach(id=> $(id).addEventListener('input',renderModal));

    // Apply selection to main form
    $('applyToForm').addEventListener('click',()=>{
      const combo = JSON.parse($('applyToForm').dataset.combo||'{"a":0,"b":0}');
      $('vials70').value = combo.a; $('vials100').value = combo.b;
      closeModal();
      updateInline();
    });

    // First paint: keep page clean
    updateInline();
  </script>
</body>
</html>
