<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dose & Vial Optimizer — 70 mg & 100 mg (HCP)</title>
  <style>
    :root {
      --page-bg: #ffffff;
      --surface: #ffffff;
      --text: #202020;
      --heading: #7a1523;
      --subtext: #4a4a4a;
      --label: #5d6064;
      --muted: #6f7175;
      --line: #d9d9d9;
      --accent: #f26b1a;
      --focus: #b6323b;
      --secondary-bg: #f5f5f5;
    }

    * { box-sizing: border-box; }

    body {
      background: var(--page-bg);
      color: var(--text);
      font-family: "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      margin: 0;
    }

    .wrap {
      max-width: 960px;
      margin: 48px auto 80px;
      padding: 0 24px;
    }

    h1 {
      color: var(--heading);
      font-size: 1.9rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      margin: 0;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--line);
    }

    h2 {
      color: var(--heading);
      font-size: 1.15rem;
      font-weight: 600;
      letter-spacing: 0.015em;
      margin: 0 0 20px;
    }

    h3 {
      color: var(--heading);
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      margin: 0 0 12px;
    }

    .sub {
      color: var(--subtext);
      margin: 16px 0 32px;
      max-width: 760px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
    }

    .grid {
      display: grid;
      gap: 16px 20px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--label);
      letter-spacing: 0.01em;
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="number"]:focus,
    select:focus {
      border-color: var(--heading);
      box-shadow: 0 0 0 3px rgba(122, 21, 35, 0.12);
      outline: none;
    }

    input[type="radio"] {
      accent-color: var(--heading);
    }

    .row {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      margin: 0;
      color: var(--text);
    }

    .pill {
      display: inline;
      padding: 0;
      border: none;
      background: none;
      color: var(--text);
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    .pill + .pill::before {
      content: " / ";
      color: var(--label);
      font-weight: 400;
    }

    .action-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 24px;
    }

    .button-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 11px 18px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: filter 0.2s ease;
    }

    .btn:hover { filter: brightness(0.96); }

    .btn:focus {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .btn.secondary {
      background: var(--secondary-bg);
      color: var(--text);
      border: 1px solid var(--line);
    }

    .btn.secondary:hover {
      background: #ebebeb;
    }

    .banner {
      margin: 32px 0;
      padding: 20px 24px;
      border: 1px solid var(--line);
      border-left: 4px solid var(--heading);
      border-radius: 12px;
      background: var(--surface);
      color: var(--subtext);
      line-height: 1.6;
    }

    .banner strong { color: var(--heading); }

    .status-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: stretch;
      justify-content: space-between;
    }

    .status-row > div {
      flex: 1 1 260px;
      min-width: 220px;
    }

    .info,
    .rec {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px 16px;
      color: var(--subtext);
      line-height: 1.4;
      display: flex;
      align-items: center;
    }

    .rec {
      border-color: var(--heading);
      color: var(--heading);
      font-weight: 600;
    }

    .status-row .rec { flex-basis: 100%; }

    .error {
      color: #b12a36;
      font-weight: 600;
      min-height: 1.4em;
    }

    .table-wrap {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      font-size: 0.95rem;
    }

    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
    }

    th {
      background: #f7f7f7;
      color: var(--label);
      text-align: left;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    td { text-align: right; }

    th:first-child,
    td:first-child { text-align: left; }

    tbody tr:hover { background: #fbfbfb; }

    tbody tr:last-child td { border-bottom: none; }

    .badge {
      display: inline;
      margin-left: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--heading);
      letter-spacing: 0.02em;
    }

    .muted { color: var(--muted); }

    .footnote {
      margin-top: 12px;
      font-size: 0.9rem;
    }

    @media (max-width: 720px) {
      .wrap {
        margin: 32px auto 64px;
        padding: 0 16px;
      }

      .card {
        padding: 20px;
      }

      .action-row {
        flex-direction: column;
        align-items: stretch;
      }

      .button-group { width: 100%; }

      .button-group .btn { flex: 1 1 auto; width: 100%; }

      .status-row > div { min-width: 100%; }
    }

    @media print {
      body {
        background: #ffffff;
        color: #000;
      }

      .wrap {
        margin: 0;
        padding: 0 12px;
      }

      .card {
        border: none;
        padding: 16px 0;
        margin: 16px 0;
      }

      .banner {
        border: none;
        border-left: none;
        padding-left: 0;
        margin: 16px 0;
      }

      .btn,
      .no-print { display: none !important; }

      table {
        border: 1px solid #c0c0c0;
      }

      th { background: #fff; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Dose & Vial Optimizer — Fixed 70 mg / 100 mg</h1>
  <div class="sub">For HCPs: choose the dose regimen, enter weight, and get the vial counts that meet or exceed the required dose with minimum waste. <strong>Only 70 mg and 100 mg vials are available.</strong></div>

  <div class="banner">For HCP guidance only. Verify calculations against the product label and local policy. <strong>No underdosing</strong> and <strong>single‑patient use</strong> are assumed. Required mg is rounded <strong>up</strong> to the nearest whole mg.</div>

  <div class="card" aria-labelledby="inputs-title">
    <h2 id="inputs-title">Inputs</h2>
    <div class="grid">
      <div>
        <label for="weight">Patient weight (kg)</label>
        <input id="weight" type="number" min="0" step="0.1" placeholder="e.g., 70"/>
      </div>
      <div>
        <label>Dose regimen (mg/kg)</label>
        <div class="row" role="radiogroup" aria-label="Dose regimen">
          <label><input type="radio" name="regimen" value="2.5" checked/> 2.5 mg/kg (Start)</label>
          <label><input type="radio" name="regimen" value="1.9"/> 1.9 mg/kg (Reduced)</label>
        </div>
      </div>
      <div>
        <label>Vial strengths (fixed)</label>
        <div class="row"><span class="pill" aria-label="Fixed vial strengths">70 mg</span><span class="pill" aria-hidden="true">100 mg</span></div>
      </div>
      <div class="no-print">
        <label>Max total vials</label>
        <input id="maxVials" type="number" min="1" step="1" value="10"/>
      </div>
    </div>
    <div class="row action-row">
      <div class="error" id="error" role="alert"></div>
      <div class="button-group no-print">
        <button class="btn" id="calcBtn" aria-label="Calculate options">Calculate options</button>
        <button class="btn secondary" id="resetBtn" aria-label="Reset">Reset</button>
        <button class="btn secondary" id="printBtn" aria-label="Print or Save as PDF">Print / Save PDF</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="status-row">
      <div id="summary" class="info">Enter weight and select a regimen, then calculate.</div>
      <div id="requiredbox" class="info" style="display:none;"><strong>Total required dose:</strong> <span id="requiredValue"></span> mg</div>
      <div id="recommend" class="rec" style="display:none;">Recommendation will appear here</div>
    </div>

    <div class="table-wrap">
      <table id="resultsTbl" style="display:none;">
        <thead>
          <tr>
            <th>Option</th>
            <th>70 mg vials</th>
            <th>100 mg vials</th>
            <th>Total (mg)</th>
            <th>Waste (mg)</th>
            <th>Waste (%)</th>
            <th>Total vials</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
    <div class="muted footnote">Tie‑breakers (in order): least waste → fewest vials.</div>
  </div>

  <div class="card no-print" id="tests">
    <h3>Self-tests</h3>
    <div class="muted" id="testResults">Will run automatically…</div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  const VIAL_A = 70; // mg
  const VIAL_B = 100; // mg

  // Actions
  $('printBtn')?.addEventListener('click', () => window.print());
  $('resetBtn')?.addEventListener('click', () => {
    $('weight').value=''; $('maxVials').value=10; document.querySelector('input[name="regimen"][value="2.5"]').checked=true;
    $('resultsTbl').style.display='none'; $('resultsBody').innerHTML='';
    $('summary').textContent='Enter weight and select a regimen, then calculate.';
    $('recommend').style.display='none'; $('error').textContent='';
    $('requiredbox').style.display='none'; $('requiredValue').textContent='';
  });

  // Utils
  function fmt(n, d=0){ if(n==null||isNaN(n)) return ''; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d}); }
  function requiredMg(weight, mgPerKg){ return Math.ceil(weight * mgPerKg); }

  // Core enumeration (no underdosing, fixed 70/100 mg)
  function enumerate(required, maxVials){
    const out=[]; const a=VIAL_A, b=VIAL_B;
    const maxA = Math.min(maxVials, Math.ceil(required/a)+6);
    const maxB = Math.min(maxVials, Math.ceil(required/b)+6);
    for(let x=0;x<=maxA;x++){
      for(let y=0;y<=maxB;y++){
        const v=x+y; if(v===0||v>maxVials) continue;
        const total = x*a + y*b; if(total < required) continue; // no underdosing
        const waste = total - required; const wastePct = total>0? waste/total : 0;
        out.push({x,y,total,waste,wastePct,totalVials:v});
      }
    }
    out.sort((p,q)=>{
      if(p.waste!==q.waste) return p.waste-q.waste;
      if(p.totalVials!==q.totalVials) return p.totalVials-q.totalVials;
      return p.total-q.total;
    });
    if(out.length){
      const minWaste=out[0].waste; const minVAmong= Math.min(...out.filter(r=>r.waste===minWaste).map(r=>r.totalVials));
      out.forEach(r=>{ if(r.waste===minWaste) r.leastWaste=true; if(r.waste===minWaste && r.totalVials===minVAmong) r.fewestVialsAmongLeast=true; });
    }
    return out;
  }

  function recommendation(opt){
    if(!opt) return '';
    const head = opt.waste===0? 'Exact match' : 'Min waste option';
    return `${head} → order ${opt.x}×70 mg and ${opt.y}×100 mg (Total ${fmt(opt.total,2)} mg; Waste ${fmt(opt.waste,2)} mg / ${(opt.wastePct*100).toFixed(2)}%; ${opt.totalVials} vial${opt.totalVials>1?'s':''})`;
  }

  // Calculate & render (max 4 options; hide dominated)
  $('calcBtn')?.addEventListener('click', () => {
    $('error').textContent=''; $('resultsTbl').style.display='none'; $('resultsBody').innerHTML='';
    const weight = parseFloat($('weight').value);
    const mgPerKg = parseFloat(document.querySelector('input[name="regimen"]:checked')?.value || '2.5');
    const maxVials = parseInt($('maxVials').value||'10',10);
    if(!(weight>0)) { $('error').textContent='Please enter patient weight.'; return; }

    const req = requiredMg(weight, mgPerKg);
    $('requiredValue').textContent = fmt(req,2);
    $('requiredbox').style.display = '';

    const opts = enumerate(req, maxVials);
    $('summary').textContent = `${fmt(mgPerKg,1)} mg/kg × ${fmt(weight,1)} kg → required ${fmt(req,2)} mg (rounded up). Two vial strengths: 70 mg & 100 mg.`;

    if(!opts.length){ $('error').textContent='No valid combinations found with current settings. Try increasing max vials.'; $('recommend').style.display='none'; return; }

    // Pareto filter (remove dominated by waste & vials)
    const pareto = opts.filter((p,i)=> !opts.some((q,j)=> j!==i && q.waste<=p.waste && q.totalVials<=p.totalVials && (q.waste<p.waste || q.totalVials<p.totalVials)));

    const best = pareto[0];
    const only70 = opts.find(o=> o.y===0);
    const only100 = opts.find(o=> o.x===0);
    const nextMixed = pareto.find(o=> o!==best && o.x>0 && o.y>0);

    let shown = [best, only70, only100, nextMixed].filter(Boolean);
    const uniq = []; const seen = new Set();
    for(const o of shown){ const k = `${o.x}|${o.y}`; if(!seen.has(k)){ seen.add(k); uniq.push(o);} }
    shown = uniq.slice(0,4);

    $('recommend').textContent = recommendation(best); $('recommend').style.display='';

    const tbody = $('resultsBody');
    shown.forEach((o,i)=>{
      const tr=document.createElement('tr');
      const n=document.createElement('td'); n.textContent=`Option ${i+1}`;
      if(o.waste===best.waste) { const b=document.createElement('span'); b.className='badge least'; b.textContent='Least waste'; n.appendChild(b);}
      if(o.totalVials===best.totalVials && o.waste===best.waste) { const b=document.createElement('span'); b.className='badge fewest'; b.textContent='Fewest vials'; n.appendChild(b);}
      tr.appendChild(n);
      const tdA=document.createElement('td'); tdA.textContent=fmt(o.x); tr.appendChild(tdA);
      const tdB=document.createElement('td'); tdB.textContent=fmt(o.y); tr.appendChild(tdB);
      const tdT=document.createElement('td'); tdT.textContent=fmt(o.total,2); tr.appendChild(tdT);
      const tdW=document.createElement('td'); tdW.textContent=fmt(o.waste,2); tr.appendChild(tdW);
      const tdWp=document.createElement('td'); tdWp.textContent=(o.total>0)?(o.wastePct*100).toFixed(2)+'%':''; tr.appendChild(tdWp);
      const tdV=document.createElement('td'); tdV.textContent=fmt(o.totalVials); tr.appendChild(tdV);
      tbody.appendChild(tr);
    });
    $('resultsTbl').style.display='';
  });

  // -------------------------
  // Self-tests (simple, inline)
  // -------------------------
  function bestOptionFor(weight, mgPerKg){
    const req = requiredMg(weight, mgPerKg);
    const opts = enumerate(req, 10);
    return opts[0];
  }

  function runSelfTests(){
    const cases = [
      {name:'70 kg @ 2.5 mg/kg → 175 mg', w:70, d:2.5, expect:{x:0,y:2,waste:25}},
      {name:'70 kg @ 1.9 mg/kg → 133 mg', w:70, d:1.9, expect:{x:2,y:0,waste:7}},
      {name:'90 kg @ 2.5 mg/kg → 225 mg (mix allowed)', w:90, d:2.5, expect:{x:1,y:2,waste:45}},
      {name:'90 kg @ 1.9 mg/kg → 171 mg', w:90, d:1.9, expect:{x:0,y:2,waste:29}},
    ];
    const lines=[]; let pass=0, fail=0;
    for(const tc of cases){
      const b = bestOptionFor(tc.w, tc.d);
      const ok = b && b.x===tc.expect.x && b.y===tc.expect.y && b.waste===tc.expect.waste;
      if(ok){ pass++; lines.push(`✅ <span class="pass">PASS</span> — ${tc.name} → ${b.x}×70 + ${b.y}×100 (waste ${b.waste} mg)`); }
      else { fail++; lines.push(`❌ <span class="fail">FAIL</span> — ${tc.name}: expected ${tc.expect.x}×70 + ${tc.expect.y}×100 (waste ${tc.expect.waste}), got ${b?`${b.x}×70 + ${b.y}×100 (waste ${b.waste})`:'no option'}`); }
    }
    $('testResults').innerHTML = `<strong>${pass} passed, ${fail} failed</strong><br>`+lines.join('<br>');
  }

  document.addEventListener('DOMContentLoaded', runSelfTests);
</script>
</body>
</html>
